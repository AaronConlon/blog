{"pageProps":{"post":{"slug":"从实现Koa文件上传接口学到的东西","content":"\n# 前言\n\n> “挺水的。” \n>\n> “比没有好！”\n\n我在写后端程序之前，阅读了`《狼书：Node.js Web 应用开发》`，选择了`koa-bodyparser`作为数据类型解析中间件，但是在需要实现文件上传的时候发现`koa-bodyparser`不支持`enctype=\"multipart/form-data\"`。\n\n在 GitHub 的 issue 板块，其核心开发者回复使用`busboy`这个库，但是看起来已经很多年没有更新文档了，于是我查找到了`koa-body`来代替`koa-bodyparser`。\n\n\n\n# 使用过程\n\n在`koa-body`的仓库`README`界面上可以看到其功能特性：\n\n[koajs/koa-body: koa body parser middleware](https://github.com/koajs/koa-body)\n\n- can handle requests such as:\n  - **multipart/form-data**\n  - **application/x-www-urlencoded**\n  - **application/json**\n  - **application/json-patch+json**\n  - **application/vnd.api+json**\n  - **application/csp-report**\n  - **text/xml**\n- option for patch to Koa or Node, or either\n- file uploads\n- body, fields and files size limiting\n\n👌🏻，支持`multipart/form-data`和文件上传，对于后端接口也提供了良好的`json`解析支持。安装好了之后，按需要的功能进行实例化，然后作为一个中间件来使用即可。\n\n```js\nconst koaBody = require(\"koa-body\")\n...\napp.use(koaBody({\n  json: true, // 开启 json 支持\n  multipart: true, // 开启 multipart/form-data 支持\n  formlimit: 2 * 1024 * 1024, // 传输大小限制，默认 56 kb\n  formidable: {\n    uploadDir: process.env.UPLOAD_PATH, // 上传保存目录\n    hash: ‘md5’, // 计算哈希值，提供算法 md1 or sha1\n    keepExtensions: true, // 保留扩展名\n    multiples: false, // 禁止多文件上传\n  }\n}))\n```\n\n可以从仓库文档看到还可以做其他操作，例如保存前重命名，这类操作都通过配置对象实例化的方式来实现。\n\n然后，我们就可以从路由函数里通过`ctx.request.files`获取到上传的文件信息，包括保存位置、扩展名‘文件名、哈希值、大小等等。\n\n我想过对于重复上传相同哈希值的文件做拦截，后来在其`issue`板块发现有人提过这个问题，这个`issue`没有关闭，有人提议使用`fs`模块做处理，暂时好像只能这样。\n\n\n\n# 其他\n\n## curl\n\n写好了接口，我打算使用`curl`来测试，其上传命令如下：\n\n```bash\n$ curl -F 'upload_filename=@demo.jpg' http://localhost/upload\n```\n\n提供`-F`参数指定请求POST类型并且添加`enctype=\"multipart/form-data`，指定上传文件名和文件路径。\n\n> 如果想上传多个文件，则继续添加 `-F xxx`即可\n\n## Vim\n\n我最近在坚持使用`vim`进行编程，今晚遇到一个问题，我希望显示相对行数，并且当前行显示为所在行的行数。\n\n其配置为：\n\n```bash\nset number relativenumber\n# or set nu rnu\n```\n\n单纯使用`set rnu`会让所有行都为相对行数，当前行为`0`，`vim7.4`版本后提供了`Hybird`混合模式，可以实现我的需求。\n\n## 文件压缩和下载\n\n此需求在网上看到了一个很好的方案，可以从参考 2 访问到，在这先略过。\n\n# 参考\n\n- [Vim’s absolute, relative and hybrid line numbers](https://jeffkreeftmeijer.com/vim-number/)\n- [How to Create and Download a Zip File with Node.js and JavaScript | CheatCode](https://cheatcode.co/tutorials/how-to-create-and-download-a-zip-file-with-node-js-and-javascript)\n\n","title":"从实现Koa文件上传接口学到的东西","date":"2021/10/31","tags":["Node","Koa"],"mainImg":"https://images.unsplash.com/photo-1593720216276-0caa6452e004?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=MnwxNjUyNjZ8MHwxfHJhbmRvbXx8fHx8fHx8fDE2MzU2MTQwODc&ixlib=rb-1.2.1&q=80&w=1080","coverImg":"https://images.unsplash.com/photo-1593720216276-0caa6452e004?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=MnwxNjUyNjZ8MHwxfHJhbmRvbXx8fHx8fHx8fDE2MzU2MTQwODc&ixlib=rb-1.2.1&q=80&w=400","intro":"最近在写浏览器扩展的后端程序，框架选择了 Koa ，新实现了文件上传的功能，在这里简单记录一下。"}},"__N_SSG":true}