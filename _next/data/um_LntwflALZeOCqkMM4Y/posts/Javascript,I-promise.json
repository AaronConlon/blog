{"pageProps":{"post":{"slug":"Javascript,I-promise","contentHtml":"<p>å¤§å®¶å¥½ï¼Œä»Šå¤©æˆ‘ä»¬è¦åˆ†äº«çš„çŸ¥è¯†ç‚¹æ˜¯<code>Promise</code>ä¸å¼‚æ­¥ç¼–ç¨‹ã€‚</p>\n<p><code>Promise</code>æ˜¯å¯¹å°šä¸å­˜åœ¨ç»“æœçš„å¯¹è±¡çš„ä¸€ä¸ªæ›¿èº«ï¼Œä¹Ÿè®¸ä½ æ›¾çœ‹åˆ°ç±»ä¼¼çš„æœ¯è¯­ï¼Œä¾‹å¦‚<code>future</code>/<code>delay</code>/<code>deferred</code>ç­‰ï¼Œå®é™…ä¸Šè¿™äº›æœ¯è¯­æè¿°çš„æ˜¯ä¸€ä¸ªç›¸åŒçš„æ¦‚å¿µï¼Œéƒ½æ˜¯ä¸€ç§å¼‚æ­¥ç¨‹åºæ‰§è¡Œçš„æœºåˆ¶ã€‚</p>\n<p>æ¥ä¸‹æ¥æˆ‘ä»¬åˆ†äº«çš„çŸ¥è¯†å°†æ¶‰åŠä»¥ä¸‹å†…å®¹ï¼š</p>\n<ul>\n<li>å‡½æ•°å›è°ƒ</li>\n<li>Promise æµ…æ</li>\n<li>Async / await</li>\n<li>Promisify</li>\n</ul>\n<h1>1. å›è°ƒ</h1>\n<p>JavaScript è¯­è¨€ä¸ºäº†è®©éƒ¨åˆ†ä»»åŠ¡æŒ‰å¼‚æ­¥çš„æ–¹å¼è¿›è¡Œï¼Œæä¾›äº†ç¼–å†™<code>å›è°ƒå‡½æ•°</code>çš„æ–¹æ³•ï¼Œè®©æŸäº›ä»»åŠ¡åœ¨è¾¾æˆä¸€äº›æ¡ä»¶ä¹‹åå†æ‰§è¡Œå¼€å‘è€…æŒ‡å®šçš„<code>å›è°ƒå‡½æ•°</code>ã€‚</p>\n<p>ä¸¾ä¸¤ä¸ªä¾‹å­:</p>\n<pre><code><span>const</span> callbackFn = <span>() =></span> {\n<span class=\"lineNumber\">2</span>  <span>// balabala</span>\n<span class=\"lineNumber\">3</span>}\n<span class=\"lineNumber\">4</span><span>// browser</span>\n<span class=\"lineNumber\">5</span><span>setTimeout</span>(callbackFn, <span>1000</span>)\n<span class=\"lineNumber\">6</span> \n<span class=\"lineNumber\">7</span><span>// nodejs</span>\n<span class=\"lineNumber\">8</span><span>const</span> fs = <span>require</span>(<span>'fs'</span>)\n<span class=\"lineNumber\">9</span>fs.readFile(<span>'filename'</span>, <span>(<span>err, data</span>) =></span> {\n<span class=\"lineNumber\">10</span>  <span>if</span>(err) <span>throw</span> err;\n<span class=\"lineNumber\">11</span>  <span>// balabala</span>\n<span class=\"lineNumber\">12</span>})\n<span class=\"lineNumber\">13</span><span>// more</span>\n<span class=\"lineNumber\">14</span><span>console</span>.log(<span>1</span>)</code></pre> \n\n<p>å¦‚ä¸Šæ‰€ç¤ºï¼Œè¦ä¹ˆå»¶è¿Ÿæ‰§è¡Œå›è°ƒï¼Œè¦ä¹ˆè¯»å–æ–‡ä»¶åæ‰§è¡Œå›è°ƒï¼ŒäºŒè€…éƒ½ä¸ä¼šç«‹å³æ‰§è¡Œä»è€Œé˜»å¡ä¸»çº¿ç¨‹ï¼Œè€Œæ˜¯å„è‡ªå…·æœ‰è‡ªå·±çš„æ‰§è¡Œæ¡ä»¶ï¼Œæ»¡è¶³æ¡ä»¶åæ”¾å…¥ä»»åŠ¡å¾ªç¯é˜Ÿåˆ—ä¸­ç­‰å¾…ä¸»çº¿ç¨‹ç©ºé—²æ‰å¾—ä»¥å–å‡ºå¹¶æ‰§è¡Œã€‚</p>\n<p>ä¸Šè¿°å›è°ƒå‡½æ•°åœ¨æŸäº›åœºæ™¯ä¸‹æ›¾è®©å¼€å‘è€…å†™å‡ºå¦‚ä¸‹ç±»å‹çš„ä»£ç ï¼š</p>\n<pre><code>\n<span class=\"lineNumber\">2</span>fs.readFile(<span>'file1.txt'</span>, <span><span>function</span>(<span>err, data</span>)</span>{\n<span class=\"lineNumber\">3</span>  <span>if</span>(err) <span>throw</span> err;\n<span class=\"lineNumber\">4</span>  <span>// ...ä¸€äº›æ“ä½œ</span>\n<span class=\"lineNumber\">5</span>  fs.readFile(<span>'file2.txt'</span>, <span><span>function</span> (<span>err, data</span>) </span>{\n<span class=\"lineNumber\">6</span>    <span>if</span>(err) <span>throw</span> err;\n<span class=\"lineNumber\">7</span>    <span>// ...ä¸€äº›æ“ä½œ</span>\n<span class=\"lineNumber\">8</span>    fs.readFile(<span>'file3.txt'</span>, <span><span>function</span> (<span>err, data</span>) </span>{\n<span class=\"lineNumber\">9</span>      <span>if</span>(err) <span>throw</span> err;\n<span class=\"lineNumber\">10</span>      <span>// ...ä¸€äº›æ“ä½œ</span>\n<span class=\"lineNumber\">11</span>      fs.readFile(<span>'file4.txt'</span>, <span><span>function</span> (<span>err, data</span>) </span>{\n<span class=\"lineNumber\">12</span>        <span>if</span>(err) <span>throw</span> err;\n<span class=\"lineNumber\">13</span>        <span>// ...ä¸€äº›æ“ä½œ</span>\n<span class=\"lineNumber\">14</span>      });\n<span class=\"lineNumber\">15</span>    });\n<span class=\"lineNumber\">16</span>  });\n<span class=\"lineNumber\">17</span>})</code></pre> \n\n<p>ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Ÿå› ä¸ºæŸäº›åœºæ™¯ä¸‹éœ€è¦å¯¹å¼‚æ­¥æ“ä½œè¿›è¡Œæ’åºï¼Œéœ€è¦ä¿è¯è¿è¡Œé€»è¾‘å…·æœ‰ä¸€å®šçš„é¡ºåºï¼Œå¹¶ä¸”è¿˜éœ€è¦å¯¹æ¯ä¸€ä¸ªå›è°ƒè¿›è¡Œé”™è¯¯å¤„ç†ã€‚</p>\n<p>ä¸Šè¿°æ¡ˆä¾‹çœç•¥äº†çœŸå®çš„é€»è¾‘ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºè¿™ç§å›è°ƒçš„åµŒå¥—è®©ä»£ç å¾ˆå®¹æ˜“å¤±æ§ï¼Œå¹¶ä¸”éš¾ä»¥é˜…è¯»å’Œç»´æŠ¤ã€‚</p>\n<p>æ— è®ºæ˜¯å†™ä¸‹è¿™æ®µä»£ç çš„äººè¿˜æ˜¯é˜…è¯»è¿™æ®µä»£ç çš„äººéƒ½è¢«å…¶æ‰€\"æŠ˜ç£¨\"ï¼Œæˆ‘ä»¬å°†æ­¤ç±»ä»£ç ç»“æ„ç§°ä¸º<code>â€œå›è°ƒåœ°ç‹±â€</code>ã€‚</p>\n<p>å³ä½¿æˆ‘ä»¬å°†ä¹‹æ‘Šå¼€ï¼Œä¸ºæ¯ä¸€ä¸ªå›è°ƒå‡½æ•°éƒ½ç¼–å†™ä¸€ä¸ªå…·åçš„ç‹¬ç«‹å‡½æ•°æ¥è°ƒç”¨ï¼Œä¾ç„¶å¯è¯»æ€§ä¸ä½³ï¼š</p>\n<pre><code>fs.readFile(<span>'file1.txt'</span>, step1);\n<span class=\"lineNumber\">2</span> \n<span class=\"lineNumber\">3</span><span><span>function</span> <span>step1</span>(<span>err, data</span>) </span>{\n<span class=\"lineNumber\">4</span>  <span>if</span>(err) <span>throw</span> err;\n<span class=\"lineNumber\">5</span>  <span>// ...</span>\n<span class=\"lineNumber\">6</span>  fs.readFile(<span>'file2.txt'</span>, step2)\n<span class=\"lineNumber\">7</span>}\n<span class=\"lineNumber\">8</span><span><span>function</span> <span>step2</span>(<span>err, data</span>) </span>{\n<span class=\"lineNumber\">9</span>  <span>if</span>(err) <span>throw</span> err;\n<span class=\"lineNumber\">10</span>  <span>// ...</span>\n<span class=\"lineNumber\">11</span>  fs.readFile(<span>'file3.txt'</span>, step3)\n<span class=\"lineNumber\">12</span>}\n<span class=\"lineNumber\">13</span><span><span>function</span> <span>step3</span>(<span>err, data</span>) </span>{\n<span class=\"lineNumber\">14</span>  <span>if</span>(err) <span>throw</span> err;\n<span class=\"lineNumber\">15</span>  <span>// ...</span>\n<span class=\"lineNumber\">16</span>  fs.readFile(<span>'file4.txt'</span>, step4)\n<span class=\"lineNumber\">17</span>}\n<span class=\"lineNumber\">18</span><span><span>function</span> <span>step4</span>(<span>err, data</span>) </span>{\n<span class=\"lineNumber\">19</span>  <span>if</span>(err) <span>throw</span> err;\n<span class=\"lineNumber\">20</span>  <span>// ...</span>\n<span class=\"lineNumber\">21</span>}</code></pre> \n\n<p>è¿™äº›ç‹¬ç«‹å‡½æ•°çš„å‘½åä¹Ÿè®¸ä¼šè®©å¼€å‘è€…è§‰å¾—éå¸¸ä¸é€‚ï¼Œä¸ºäº†å±•å¼€å±‚å±‚åµŒå¥—ï¼Œæˆ‘ä»¬ç¼–å†™äº†è®¸å¤šå‡ ä¹ä¸ä¼šè¢«<code>é‡ç”¨</code>çš„å‡½æ•°ï¼Œå³ä½¿ç°ä»£ç¼–è¾‘å™¨åœ¨ä»£ç è·³è½¬çš„åŠŸèƒ½ä¸Šéå¸¸æ–¹ä¾¿ï¼Œé˜…è¯»æ­¤ç±»ä»£ç çš„æ—¶å€™ä¾ç„¶ä¼šè®©æˆ‘ä»¬ä¸æ–­çš„è½¬ç§»è§†çº¿ã€‚</p>\n<blockquote>\n<p>â€œæ‡’æƒ°â€ä½¿äººè¿›æ­¥ã€‚</p>\n</blockquote>\n<p>ä½¿ç”¨<code>Promise</code>,å¯ä»¥é¿å…æ­¤ç±»é—®é¢˜ï¼Œæ˜¾è‘—å‡å°‘ç¼–ç é‡ï¼Œæé«˜ä»£ç çš„å¯è¯»æ€§ã€‚</p>\n<h1>2. Promise</h1>\n<blockquote>\n<p>IE æµè§ˆå™¨ä¸æ”¯æŒ<code>Promise</code>,æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>bluebird</code>æˆ–<code>es6-promise</code>ç­‰ç¬¬ä¸‰æ–¹åº“.</p>\n</blockquote>\n<h2>2.1 promise æµ…æ</h2>\n<p>ä½¿ç”¨<code>new</code>å®ä¾‹åŒ–çš„<code>Promise</code>å¯¹è±¡å…·æœ‰ä¸‰ç§çŠ¶æ€:</p>\n<ul>\n<li><code>Fulfilled</code> - <code>has resolution</code>: resolve æˆåŠŸ,è°ƒç”¨ <code>onFulfilled</code>å‡½æ•°</li>\n<li><code>Rejected</code> - <code>has rejection</code>: reject, è°ƒç”¨<code>onRejected</code>å‡½æ•°</li>\n<li><code>Pending</code> - <code>unresolved</code>: åˆå§‹åŒ–çŠ¶æ€</li>\n</ul>\n<blockquote>\n<p>çŸ­æ¨ªçº¿å·¦è¾¹æ˜¯<code>Promise/A+</code>æœ¯è¯­,è€Œå³è¾¹åˆ™æ˜¯<code>ES6 Promise</code>æœ¯è¯­.</p>\n</blockquote>\n<p><img src=\"https://raw.githubusercontent.com/youyiqin/markdown_imgs/master/image-1582215000590-ffa807c19d5f6959de485fc66664e123.png\" alt=\"\"></p>\n<p>åˆå§‹çŠ¶æ€ä¸º<code>pending</code>,è½¬ä¸º<code>Fulfilled</code>æˆ–è€…<code>Rejected</code>ä¹‹åä¸ä¼šå†æœ‰å˜åŒ–.<code>Fulfilled</code>å’Œ<code>Rejected</code>çŠ¶æ€ä¹Ÿè¢«ç§°ä¸º<code>Settled</code>ã€‚</p>\n<p><code>Promise</code>çš„çŠ¶æ€æµè½¬å¹¶ä¸å¤æ‚ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦æ³¨æ„å…¶ä¸­ä¸€äº›ç»†èŠ‚ã€‚</p>\n<blockquote>\n<p>æœ¬æ–‡ä¸ä¼šå¯¹<code>promise</code>åšé¢é¢ä¿±åˆ°çš„ä»‹ç»,æ¨èé˜…è¯»å®˜æ–¹æ–‡æ¡£.</p>\n</blockquote>\n<p>é¦–å…ˆ,æˆ‘ä»¬æ¥åˆ›å»ºä¸€ä¸ª<code>promise</code>å®ä¾‹:</p>\n<pre><code><span>// å®ä¾‹åŒ–</span>\n<span class=\"lineNumber\">2</span><span>const</span> promise = <span>new</span> <span>Promise</span>(<span>(<span>resolve, reject</span>) =></span> {\n<span class=\"lineNumber\">3</span>  <span>// balabala</span>\n<span class=\"lineNumber\">4</span>  <span>if</span>(...) {\n<span class=\"lineNumber\">5</span>    <span>// å®ä¾‹çŠ¶æ€å˜æ›´ï¼Œè®¾ç½®å€¼</span>\n<span class=\"lineNumber\">6</span>    resolve(value) <span>// success</span>\n<span class=\"lineNumber\">7</span>    resolve(...) <span>// å¿½ç•¥</span>\n<span class=\"lineNumber\">8</span>  } <span>else</span> {\n<span class=\"lineNumber\">9</span>  \treject(reason) <span>// failure</span>\n<span class=\"lineNumber\">10</span>  }\n<span class=\"lineNumber\">11</span>})\n<span class=\"lineNumber\">12</span><span>// é“¾å¼è°ƒç”¨ï¼Œå®ä¾‹æ–¹æ³• then è¿”å›ä¸€ä¸ªæ–°çš„å®ä¾‹</span>\n<span class=\"lineNumber\">13</span>promise\n<span class=\"lineNumber\">14</span>  .then(<span><span>function</span>(<span>value</span>) </span>{\n<span class=\"lineNumber\">15</span>\t\t<span>// balabala</span>\n<span class=\"lineNumber\">16</span>  })\n<span class=\"lineNumber\">17</span>\t.then(<span><span>function</span>(<span>value</span>) </span>{\n<span class=\"lineNumber\">18</span>\t\t<span>// balabala</span>\n<span class=\"lineNumber\">19</span>  })\n<span class=\"lineNumber\">20</span>\t.catch(<span><span>reason</span> =></span> {\n<span class=\"lineNumber\">21</span>  \t<span>// balabala</span>\n<span class=\"lineNumber\">22</span>  })\n<span class=\"lineNumber\">23</span>\t.finally(<span>() =></span> {})</code></pre> \n\n<p>ä¸Šè¿°ç¤ºä¾‹å±•ç¤ºäº†<code>promise</code>çš„ä¸€äº›ç‰¹æ€§ï¼Œå¦‚å®ä¾‹åŒ–ã€çŠ¶æ€è½¬æ¢èµ‹å€¼ã€é“¾å¼è°ƒç”¨å’Œå¼‚å¸¸å¤„ç†ï¼Œä¸‹é¢æˆ‘ä»¬ä¼šè®²åˆ°é™æ€æ–¹æ³•å’Œå®ä¾‹æ–¹æ³•ã€‚</p>\n<h2>2.1 Promise æ„é€ å™¨</h2>\n<p>æˆ‘ä»¬é€šè¿‡<code>new Promise(executor)</code>å®ä¾‹åŒ–ä¸€ä¸ª<code>promise</code>çš„æ—¶å€™,å…¶çŠ¶æ€ä¸º<code>pending</code>.åœ¨å®ä¾‹åŒ–çš„æ—¶å€™ä¼ å…¥ä¸€ä¸ªå‡½æ•°<code>executorï¼ˆæ‰§è¡Œå™¨ï¼‰</code>ï¼Œæ­¤å‡½æ•°å°†ä¼šè·å–ä¸¤ä¸ªå®å‚<code>resolve</code>å’Œ<code>reject</code>å‡½æ•°ï¼ŒäºŒè€…éƒ½å¯ä»¥æ”¹å˜å®ä¾‹çš„çŠ¶æ€å’Œå€¼ã€‚</p>\n<blockquote>\n<p>ä¸æä¾› <code>executor</code> å°†æŠ›å‡º <code>typeError</code></p>\n</blockquote>\n<p>ä¸Šè¿°ä»£ç çš„ç‰‡æ®µï¼š</p>\n<pre><code><span>// å®ä¾‹åŒ–</span>\n<span class=\"lineNumber\">2</span><span>const</span> promise = <span>new</span> <span>Promise</span>(<span>(<span>resolve, reject</span>) =></span> {\n<span class=\"lineNumber\">3</span>  <span>// balabala</span>\n<span class=\"lineNumber\">4</span>  <span>if</span>(...) {\n<span class=\"lineNumber\">5</span>    <span>// å®ä¾‹çŠ¶æ€å˜æ›´ï¼Œè®¾ç½®å€¼</span>\n<span class=\"lineNumber\">6</span>    resolve(value) <span>// success</span>\n<span class=\"lineNumber\">7</span>    resolve(...) <span>// å¿½ç•¥</span>\n<span class=\"lineNumber\">8</span>  } <span>else</span> {\n<span class=\"lineNumber\">9</span>  \treject(reason) <span>// failure</span>\n<span class=\"lineNumber\">10</span>  }\n<span class=\"lineNumber\">11</span>})</code></pre> \n\n<p>éœ€è¦å…³æ³¨ä»¥ä¸‹å‡ ç‚¹ï¼š</p>\n<ul>\n<li><code>Executor</code>å‡½æ•°çš„å‚æ•°æ²¡æœ‰é™åˆ¶ï¼Œä½†é€šå¸¸æˆ‘ä»¬ä¼šå£°æ˜ä¸¤ä¸ªå½¢å‚å‡½æ•°ï¼š<code>resolve</code>å’Œ<code>reject</code>ï¼Œ<code>executor</code>å†…éƒ¨ä½¿ç”¨æ­¤äºŒè€…å¯ä»¥æ˜¾å¼åœ°è½¬æ¢<code>Promise</code>å®ä¾‹çš„çŠ¶æ€ï¼Œè®¾ç½®å…¶å€¼ã€‚ï¼ˆä¸ä½¿ç”¨è¿™ä¸¤ä¸ªå‡½æ•°æ¥è½¬æ¢å®ä¾‹çŠ¶æ€æ„å‘³ç€æ­¤å®ä¾‹çš„çŠ¶æ€ä¸ä¼šæ”¹å˜ï¼Œè¿™ä¹Ÿå†™å¹¶æ²¡æœ‰å¤šå¤§æ„ä¹‰ï¼‰ã€‚</li>\n<li><code>resolve</code>å’Œ<code>reject</code>å‡½æ•°çš„å®å‚å¯ä»¥æ˜¯ä¸åŒç±»å‹çš„å€¼ï¼Œä½†æ˜¯ä¼šè¢«è¿›ä¸€æ­¥å¤„ç†ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ˜¾ç¤ºè½¬æ¢çŠ¶æ€è®¾ç½®å€¼çš„æ—¶å€™ï¼Œä¼ å…¥çš„å‚æ•°ä¸ä¸€å®šä¼šç›´æ¥ä½œä¸º<code>settled</code>çŠ¶æ€çš„å€¼ã€‚</li>\n<li><code>pending</code>çŠ¶æ€åˆ°<code>settled</code>çŠ¶æ€æ˜¯ä¸å¯é€†çš„ï¼Œå¹¶ä¸”åœ¨<code>executor</code>ä¸­çš„<code>resolve</code>å’Œ<code>reject</code>å‡½æ•°åªèƒ½æ‰§è¡Œä¸€æ¬¡ï¼Œåç»­å†æ‰§è¡Œå°†ä¼šè¢«å¿½ç•¥ã€‚</li>\n</ul>\n<blockquote>\n<p><code>executor</code>å‡½æ•°æ˜¯åŒæ­¥æ‰§è¡Œçš„ã€‚<code>resolve</code>å’Œ<code>reject</code>å‡½æ•°æ¥æ”¶ä»»æ„ç±»å‹çš„å€¼ã€‚</p>\n</blockquote>\n<p>æˆ‘ä»¬æ¥çœ‹çœ‹ç»™<code>resolve</code>å‡½æ•°ä¼ å…¥ä»¥ä¸‹ä¸‰ç§ä¸åŒçš„å€¼ä¼šæœ‰æ€æ ·çš„ç»“æœã€‚</p>\n<ul>\n<li>åŸå§‹ç±»å‹å€¼</li>\n<li>Promise å®ä¾‹</li>\n<li>thenable å¯¹è±¡</li>\n</ul>\n<p>é¦–å…ˆæ˜¯<code>åŸå§‹ç±»å‹å€¼</code>ï¼š</p>\n<pre><code><span>const</span> p = <span>new</span> <span>Promise</span>(<span>(<span>resolve, reject</span>) =></span> {\n<span class=\"lineNumber\">2</span>  resolve(<span>Symbol</span>())\n<span class=\"lineNumber\">3</span>  <span>// resolve(1)</span>\n<span class=\"lineNumber\">4</span>  <span>// resolve('1')</span>\n<span class=\"lineNumber\">5</span>  <span>// resolve(null)</span>\n<span class=\"lineNumber\">6</span>  <span>// resolve(undefined)</span>\n<span class=\"lineNumber\">7</span>  <span>// resolve(1n)</span>\n<span class=\"lineNumber\">8</span>  <span>// resolve(true)</span>\n<span class=\"lineNumber\">9</span>  <span>// reject ä¹Ÿæ˜¯å¦‚æ­¤</span>\n<span class=\"lineNumber\">10</span>})\n<span class=\"lineNumber\">11</span> \n<span class=\"lineNumber\">12</span>p.then(<span>(<span>v</span>) =></span> {\n<span class=\"lineNumber\">13</span>  <span>console</span>.log(<span>'resolve'</span>ï¼Œ v);\n<span class=\"lineNumber\">14</span>}).catch(<span>(<span>i</span>) =></span> {\n<span class=\"lineNumber\">15</span>  <span>console</span>.log(<span>'reject'</span>, i);\n<span class=\"lineNumber\">16</span>})</code></pre> \n\n<p>åŸå§‹ç±»å‹æ•°æ®ä¼ å…¥<code>resolve</code>å‡½æ•°ï¼Œéƒ½èƒ½é¡ºåˆ©å°†çŠ¶æ€è½¬ä¸º<code>fulfilled</code>å¹¶ä¸”è®¾ç½®ä¸ºå½“å‰çŠ¶æ€ä¸‹çš„å€¼ã€‚ä½¿ç”¨<code>reject</code>å‡½æ•°åˆ™å°†çŠ¶æ€è½¬ä¸º<code>rejected</code>,å€¼åˆ™æ˜¯åŸå§‹ç±»å‹çš„å€¼ã€‚</p>\n<p>å…¶æ¬¡ï¼Œæ¥çœ‹çœ‹ä¼ å…¥<code>Promise</code>å¯¹è±¡ã€‚</p>\n<pre><code><span>const</span> p = <span>new</span> <span>Promise</span>(<span>(<span>resolve, reject</span>) =></span> {\n<span class=\"lineNumber\">2</span>  resolve(<span>Promise</span>.resolve(<span>1</span>))\n<span class=\"lineNumber\">3</span>  <span>// or</span>\n<span class=\"lineNumber\">4</span>  reject(<span>Promise</span>.resolve(<span>1</span>))\n<span class=\"lineNumber\">5</span>})\n<span class=\"lineNumber\">6</span>p.then(<span>(<span>v</span>) =></span> {\n<span class=\"lineNumber\">7</span>  <span>console</span>.log(<span>'resolve'</span>, v);\n<span class=\"lineNumber\">8</span>}).catch(<span>(<span>i</span>) =></span> {\n<span class=\"lineNumber\">9</span>  <span>console</span>.log(<span>'reject'</span>, i)\n<span class=\"lineNumber\">10</span>})\n<span class=\"lineNumber\">11</span><span>// output</span>\n<span class=\"lineNumber\">12</span>resolve <span>1</span></code></pre> \n\n<p>å¦‚æœä¼ å…¥ç»™<code>promise</code>çš„å‚æ•°ä¹Ÿæ˜¯ä¸€ä¸ª<code>Promise</code>å®ä¾‹ï¼Œåˆ™ç›¸å½“äºä¸€ä¸ªç©ºåŒ…è£…ï¼Œæœ€ç»ˆå°†å¾—åˆ°ä¸€ä¸ªç›¸åŒçŠ¶æ€å’Œå€¼çš„<code>Promise</code>å®ä¾‹ã€‚</p>\n<blockquote>\n<p><code>reject(Promise.resolve(1))</code> ä¸ä¼šç…§æ¬<code>resolve</code>çš„ç‰¹æ€§ï¼Œå¯¹äºä¼ å…¥ä¸€ä¸ª<code>Promise</code>å®ä¾‹çš„æƒ…å½¢ï¼Œä¼šå°†ä¹‹ä½œä¸º<code>Rejected</code>çŠ¶æ€ä¸‹çš„<code>reason</code>ã€‚</p>\n</blockquote>\n<pre><code><span>const</span> p = <span>new</span> <span>Promise</span>(<span>(<span>resolve, reject</span>) =></span> {\n<span class=\"lineNumber\">2</span>  resolve(<span>Promise</span>.reject(<span>1</span>))\n<span class=\"lineNumber\">3</span>})\n<span class=\"lineNumber\">4</span><span>// output</span>\n<span class=\"lineNumber\">5</span>reject <span>1</span></code></pre> \n\n<p>æ¥ç€æˆ‘ä»¬æ¥çœ‹çœ‹ä¼ å…¥ä¸€ä¸ªæ™®é€šçš„ <code>thenable</code> å¯¹è±¡ã€‚</p>\n<blockquote>\n<p>å…·æœ‰<code>then</code>æ–¹æ³•çš„å¯¹è±¡ç§°ä¸º<code>thenable</code>å¯¹è±¡ï¼Œ<code>Promise</code>å®ä¾‹å¯¹è±¡ä¹Ÿæ˜¯ä¸€ç§<code>thenable</code>å¯¹è±¡ã€‚</p>\n</blockquote>\n<pre><code><span>const</span> obj = {\n<span class=\"lineNumber\">2</span>  <span>name</span>: <span>'Miao'</span>,\n<span class=\"lineNumber\">3</span>  <span><span>then</span>(<span></span>)</span> {\n<span class=\"lineNumber\">4</span>    <span>console</span>.log(<span>'this is then'</span>, <span>arguments</span>);\n<span class=\"lineNumber\">5</span>    <span>arguments</span>[<span>0</span>](<span>1</span>)\n<span class=\"lineNumber\">6</span>  }\n<span class=\"lineNumber\">7</span>}\n<span class=\"lineNumber\">8</span><span>const</span> p = <span>new</span> <span>Promise</span>(<span>(<span>resolve, reject</span>) =></span> {\n<span class=\"lineNumber\">9</span>  resolve(obj)\n<span class=\"lineNumber\">10</span>})\n<span class=\"lineNumber\">11</span> \n<span class=\"lineNumber\">12</span>p.then(<span>(<span>v</span>) =></span> {\n<span class=\"lineNumber\">13</span>  <span>console</span>.log(<span>'resolve'</span>, v);\n<span class=\"lineNumber\">14</span>}).catch(<span>(<span>i</span>) =></span> {\n<span class=\"lineNumber\">15</span>  <span>console</span>.log(<span>'reject'</span>, i)\n<span class=\"lineNumber\">16</span>})\n<span class=\"lineNumber\">17</span><span>// output</span>\n<span class=\"lineNumber\">18</span><span>this</span> is then [Arguments] {\n<span class=\"lineNumber\">19</span>  <span>'0'</span>: [<span>Function</span> (anonymous)],\n<span class=\"lineNumber\">20</span>  <span>'1'</span>: [<span>Function</span> (anonymous)]\n<span class=\"lineNumber\">21</span>}\n<span class=\"lineNumber\">22</span>resolve <span>1</span></code></pre> \n\n<p><code>executor</code>å†…<code>resolve</code>ä¸€ä¸ª<code>thenable</code>å¯¹è±¡ï¼Œåˆ™ä¼šå°†<code>then</code>æ–¹æ³•è§†ä½œä¸€ä¸ª<code>executor</code>ï¼Œåœ¨å…¶å†…éƒ¨å¯ä»¥æ˜¾ç¤ºç¼–å†™<code>resolve</code>å’Œ<code>reject</code>çš„é€»è¾‘æ¥æ”¹å˜æ•´ä¸ª<code>Promise</code>å®ä¾‹çš„çŠ¶æ€å’Œå€¼ã€‚</p>\n<h2>2.2 Promise å®ä¾‹æ–¹æ³•</h2>\n<p><code>Promise</code>å®ä¾‹æœ‰ä¸‰ä¸ªå®ä¾‹æ–¹æ³•ï¼š</p>\n<ul>\n<li><code>then</code></li>\n<li><code>catch</code></li>\n<li><code>finally</code></li>\n</ul>\n<blockquote>\n<p>é‡ç”³ï¼š<code>promise</code>å®ä¾‹çš„çŠ¶æ€è½¬æ¢æ˜¯å•å‘çš„,ä¸€æ—¦<code>settled</code>åˆ™ä¸å¯é€†è½¬,åŒæ—¶æˆ‘ä»¬å¯ä»¥å¤šæ¬¡åˆ©ç”¨æ­¤<code>settled</code>çŠ¶æ€çš„å®ä¾‹ã€‚</p>\n</blockquote>\n<p>é¦–å…ˆæ˜¯<code>then(onFulfilled, onRejected)</code>æ–¹æ³•ï¼Œæ­¤æ–¹æ³•æ¥æ”¶ä¸¤ä¸ªå›è°ƒå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œåœ¨<code>Promise</code>çŠ¶æ€ä¸º<code>pending</code>çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ­¤æ–¹æ³•ç†è§£ä¸ºæ³¨å†ŒçŠ¶æ€è½¬å˜ä¸º<code>Fulfilled</code>å’Œ<code>Rejected</code>åæ‰§è¡Œçš„å›è°ƒå‡½æ•°ï¼Œå¹¶ä¸”è¿™äº›å›è°ƒå‡½æ•°çš„æ‰§è¡Œæ˜¯å¼‚æ­¥çš„ã€‚</p>\n<blockquote>\n<p><code>Promise</code>åªèƒ½è½¬æ¢ä¸€æ¬¡ï¼Œå› æ­¤ä¸Šè¿°ä¸¤ä¸ªå‚æ•°çš„æ“ä½œæ˜¯äº’æ–¥çš„ã€‚</p>\n</blockquote>\n<p>åœ¨å®ç°ä¸Š<code>Node</code>å¯ä»¥é€šè¿‡<code>process.nextTick</code>æ¥åˆ›å»ºæ–°çš„å¾®ä»»åŠ¡ï¼Œåœ¨æµè§ˆå™¨ç«¯åˆ™å¯ä»¥é€šè¿‡<code>MutationObserver</code>åŠŸèƒ½åˆ›å»ºå¾®ä»»åŠ¡ã€‚</p>\n<p>ä»¥ä¸‹ä¸¤ç§<code>then</code>å‡½æ•°çš„ä¼ å‚éƒ½ä¼šè¢«å¿½ç•¥, å¹¶ä¸”å¼‚æ­¥è¿”å›ä¸€ä¸ªç›¸åŒå€¼çš„<code>Promise</code>æ–°å®ä¾‹ï¼š</p>\n<pre><code><span>// ä¼ éå‡½æ•°å¤„ç†å¯¹è±¡</span>\n<span class=\"lineNumber\">2</span><span>Promise</span>.resolve(<span>1</span>).then(<span>'sss'</span>)\n<span class=\"lineNumber\">3</span><span>// ä¸ä¼ å€¼</span>\n<span class=\"lineNumber\">4</span><span>Promise</span>.resolve(<span>1</span>).then()\n<span class=\"lineNumber\">5</span> \n<span class=\"lineNumber\">6</span><span>const</span> p = <span>Promise</span>.resolve(<span>1</span>)\n<span class=\"lineNumber\">7</span><span>let</span> c = p.then()\n<span class=\"lineNumber\">8</span><span>console</span>.log(p);\n<span class=\"lineNumber\">9</span><span>setTimeout</span>(<span>() =></span> {\n<span class=\"lineNumber\">10</span>  <span>console</span>.log(c);\n<span class=\"lineNumber\">11</span>}, <span>200</span>);\n<span class=\"lineNumber\">12</span><span>// output</span>\n<span class=\"lineNumber\">13</span><span>Promise</span> { <span>1</span> }\n<span class=\"lineNumber\">14</span><span>Promise</span> { <span>1</span> }</code></pre> \n\n<p>ä¸æ¨èç¼–å†™ä¸Šè¿°<code>then</code>æ–¹æ³•ï¼Œæˆ‘ä»¬åªéœ€è¦çŸ¥é“æ­¤ç§æƒ…å½¢<code>Promise</code>ä¼šå¦‚ä½•å¤„ç†æ•´ä½“çš„é€»è¾‘æµç¨‹ã€‚</p>\n<blockquote>\n<p>æ— è®º<code>Promise</code>å®ä¾‹å¤„äºä½•ç§çŠ¶æ€ï¼Œæˆ‘ä»¬æ³¨å†Œå›è°ƒå‡½æ•°éƒ½å°†å¼‚æ­¥æ‰§è¡Œã€‚</p>\n</blockquote>\n<p>å…¶æ¬¡ï¼Œ<code>catch</code>æ–¹æ³•å¯ä»¥ç†è§£ä¸º<code>then</code>æ–¹æ³•çš„è¯­æ³•ç³–å½¢å¼ï¼Œæˆ‘ä»¬å¯ä»¥å°†<code>then(undefiled, onRejected)</code>è§†ä¸º<code>catch(onRejected)</code>ä¸€ç§å½¢å¼ï¼Œå¼€å‘è€…å¯ä»¥è‡ªç”±é€‰æ‹©å¦‚ä½•ç¼–å†™<code>Promise</code>å®ä¾‹ä»<code>pending</code>è½¬ä¸º<code>settled</code>çŠ¶æ€åçš„å¼‚æ­¥å›è°ƒå‡½æ•°ã€‚</p>\n<p>æœ€åï¼Œ<code>finally</code>æ–¹æ³•åˆ™ç›¸å½“äºæ³¨å†Œä¸€ä¸ª<code>Promise</code>å®ä¾‹<code>settled</code>ä¹‹åçš„æ¸…ç†æ–¹æ³•ï¼Œé€šå¸¸æˆ‘ä»¬å¯ä»¥ä¼ å…¥ä¸€ä¸ªå…·æœ‰æ¸…ç†åŠŸèƒ½çš„å‡½æ•°ä½œä¸ºå‚æ•°ã€‚</p>\n<blockquote>\n<p><code>finally</code>è¿”å›ä¸€ä¸ªæ–°çš„<code>Promise</code>å®ä¾‹ï¼Œ<code>finally</code>è®¾è®¡ä¸ºä¸€ä¸ªä¸çŠ¶æ€æ— å…³çš„æ–¹æ³•ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹åªæ˜¯ä¼ é€’ä¸Šå±‚çš„<code>Promise</code>ï¼Œé™¤éæ˜¾å¼åœ°è¿”å›ä¸€ä¸ªæ–°çš„<code>Promise</code>å®ä¾‹ï¼Œæˆ–è€…æŠ›å‡ºå¼‚å¸¸è¿”å›<code>Rejected</code>çŠ¶æ€çš„å®ä¾‹ã€‚</p>\n</blockquote>\n<p>è®©æˆ‘ä»¬æ¥å†™ä¸€ä¸ªç¤ºä¾‹ï¼š</p>\n<pre><code><span>new</span> <span>Promise</span>(<span>(<span>resolve ,reject</span>) =></span> resolve(<span>1</span>))\n<span class=\"lineNumber\">2</span>  .then(<span>() =></span> {\n<span class=\"lineNumber\">3</span>    <span>console</span>.log(<span>'1'</span>);\n<span class=\"lineNumber\">4</span>  })\n<span class=\"lineNumber\">5</span>  .then(<span>(<span>v</span>) =></span> {\n<span class=\"lineNumber\">6</span>    <span>console</span>.log(<span>'2'</span>, v);\n<span class=\"lineNumber\">7</span>    <span>throw</span> <span>new</span> <span>Error</span>(<span>'my error'</span>)\n<span class=\"lineNumber\">8</span>  })\n<span class=\"lineNumber\">9</span>  .then(<span>() =></span> {\n<span class=\"lineNumber\">10</span>    <span>console</span>.log(<span>'3'</span>);\n<span class=\"lineNumber\">11</span>  })\n<span class=\"lineNumber\">12</span>  .catch(<span><span>err</span> =></span> {\n<span class=\"lineNumber\">13</span>    <span>console</span>.log(<span>'catch any error'</span>);\n<span class=\"lineNumber\">14</span>    <span>return</span> <span>4</span> <span>// æˆ–è€… return Promise.resolve(4)</span>\n<span class=\"lineNumber\">15</span>  })\n<span class=\"lineNumber\">16</span>  .then(<span>(<span>v</span>) =></span> {\n<span class=\"lineNumber\">17</span>    <span>console</span>.log(<span>'4'</span>, v);\n<span class=\"lineNumber\">18</span>    <span>return</span> <span>5</span>\n<span class=\"lineNumber\">19</span>  })\n<span class=\"lineNumber\">20</span>  .finally(<span>() =></span> {\n<span class=\"lineNumber\">21</span>    <span>console</span>.log(<span>'finally'</span>);\n<span class=\"lineNumber\">22</span>  })\n<span class=\"lineNumber\">23</span>  .then(<span><span>v</span> =></span> {\n<span class=\"lineNumber\">24</span>    <span>console</span>.log(<span>5</span>, v);\n<span class=\"lineNumber\">25</span>  })\n<span class=\"lineNumber\">26</span><span>// output</span>\n<span class=\"lineNumber\">27</span><span>1</span>\n<span class=\"lineNumber\">28</span><span>2</span> <span>undefined</span>\n<span class=\"lineNumber\">29</span><span>catch</span> any error\n<span class=\"lineNumber\">30</span><span>4</span> <span>4</span>\n<span class=\"lineNumber\">31</span><span>finally</span>\n<span class=\"lineNumber\">32</span><span>5</span> <span>5</span></code></pre> \n\n<blockquote>\n<p><code>Promise</code>å®ä¾‹æ”¯æŒé“¾å¼è°ƒç”¨,æ¯ä¸ª<code>then</code>å‡½æ•°å†…éƒ¨æœ€åå°†è¿”å›ä¸€ä¸ªå…¨æ–°çš„<code>promise</code>å®ä¾‹ã€‚</p>\n</blockquote>\n<p><code>then</code>æ–¹æ³•é»˜è®¤è¿”å›ä¸€ä¸ªå€¼ä¸º<code>undefined</code>,çŠ¶æ€ä¸º<code>fulfilled</code>çš„<code>Promise</code>å®ä¾‹.</p>\n<blockquote>\n<p><code>å›è°ƒå‡½æ•°</code>çš„å†™æ³•ç¼–å†™å¯ä»¥ä¸€æ¬¡æ€§ç›‘å¬æ‰€æœ‰å›è°ƒå‡½æ•°çš„é”™è¯¯å¤„ç†é€»è¾‘æ˜¯å¾ˆå›°éš¾çš„,<code>Promiseå®ä¾‹</code>çš„å®ä¾‹æ–¹æ³•<code>catch</code>èƒ½å¤„ç†é“¾å¼è°ƒç”¨ä¹‹å‰æ‰€æœ‰çš„<code>then</code>å‡½æ•°é”™è¯¯å’Œæ˜¾å¼çš„<code>reject</code>è¡Œä¸º.</p>\n</blockquote>\n<p><code>catch</code>æ–¹æ³•èƒ½å¤„ç†é“¾å¼è°ƒç”¨ä¹‹å‰æ‰€æœ‰çš„å¼‚å¸¸ï¼Œä¹Ÿå°±æ˜¯è¯´å½“å‰é¢çš„<code>Promise</code>çŠ¶æ€è½¬ä¸º<code>rejected</code>çš„æ—¶å€™ï¼Œä¼š\"è·³è¿‡\"<code>then</code>æ–¹æ³•ï¼Œä»è€Œæ‰§è¡Œ<code>catch</code>æ–¹æ³•æ³¨å†Œçš„å¼‚æ­¥å›è°ƒã€‚</p>\n<blockquote>\n<p><code>Promise</code>çš„å¼‚æ­¥æ³¨å†Œç›‘å¬å‡½æ•°çš„æ‰§è¡Œé¡ºåºå–å†³äºä½¿ç”¨å®ä¾‹æ–¹æ³•æ·»åŠ çš„é¡ºåºã€‚</p>\n</blockquote>\n<h2>2.3 Promise é™æ€æ–¹æ³•</h2>\n<p><code>Promise</code>ç±»å…·æœ‰ä¸¤ä¸ªèƒ½åˆ›å»ºä¸€ä¸ªæ–°çš„å®ä¾‹çš„é™æ€æ–¹æ³•:</p>\n<ul>\n<li>Promise.resolve(value)</li>\n<li>Promise.reject(reason)</li>\n</ul>\n<p>äºŒè€…åŒºåˆ«åœ¨äºè¿”å›çš„<code>promise</code>å®ä¾‹çš„çŠ¶æ€,å‰è€…ä¸º<code>fulfilled</code>,åè€…ä¸º<code>rejected</code>.</p>\n<p><code>Promise.resolve(value)</code>å¯ä»¥è§†ä¸ºä»¥ä¸‹ä»£ç çš„ç®€å†™:</p>\n<pre><code><span>new</span> <span>Promise</span>(<span><span>resolve</span> =></span> {\n<span class=\"lineNumber\">2</span>  resolve(value)\n<span class=\"lineNumber\">3</span>})</code></pre> \n\n<p><code>Promise.reject(reason)</code>äº¦ç±»ä¼¼ã€‚</p>\n<p>å†æ¬¡é‡ç”³ï¼Œä¼ å…¥çš„å®å‚<code>ï¼ˆvalue/reasonï¼‰</code>å¯ä»¥æœ‰å‡ ç§æƒ…å½¢ï¼š</p>\n<ul>\n<li>å¦‚æœ<code>value</code>æ˜¯ä¸€ä¸ªåŸå§‹æ•°æ®ç±»å‹çš„å€¼ï¼Œåˆ™è®¾ç½®<code>Promise</code>å®ä¾‹å€¼ä¸ºæ­¤å€¼ï¼ŒçŠ¶æ€è®¾ç½®ä¸º<code>fulfilled</code></li>\n<li>å¦‚æœ<code>value</code>æ˜¯ä¸€ä¸ª<code>Promise</code>å®ä¾‹ï¼Œåˆ™æ²¿ç”¨æ­¤å®ä¾‹çš„çŠ¶æ€å’Œå€¼ã€‚</li>\n<li>å¦‚æœä¼ å…¥çš„å®å‚æ˜¯ä¸€ä¸ªé<code>Promise</code>çš„<code>thenable</code>å¯¹è±¡ï¼Œåˆ™è°ƒç”¨æ­¤å¯¹è±¡çš„<code>then</code>æ–¹æ³•ï¼Œå¹¶ä¸”ä¼ å…¥<code>resolve</code>å’Œ<code>reject</code>ä½œä¸ºå®å‚,å°†<code>then</code>æ–¹æ³•ä½œä¸º<code>executor</code>ï¼Œåœ¨å†…éƒ¨å¯ä»¥è®¾ç½®å½“å‰å®ä¾‹çš„çŠ¶æ€å’Œå€¼, å¿…é¡»æ˜¾ç¤ºè°ƒç”¨<code>resolve</code>æˆ–è€…<code>reject</code>æ–¹æ³•ï¼Œä½¿ç”¨<code>return</code>å…¶ä»–å€¼åˆ™æ— æ•ˆã€‚</li>\n</ul>\n<pre><code><span>const</span> obj = {\n<span class=\"lineNumber\">2</span>  <span>name</span>: <span>'o'</span>,\n<span class=\"lineNumber\">3</span>  <span><span>then</span>(<span></span>)</span> {\n<span class=\"lineNumber\">4</span>    <span>console</span>.log(<span>'this is then'</span>, <span>arguments</span>);\n<span class=\"lineNumber\">5</span>    <span>arguments</span>[<span>1</span>](<span>1</span>)\n<span class=\"lineNumber\">6</span>  }\n<span class=\"lineNumber\">7</span>}\n<span class=\"lineNumber\">8</span><span>const</span> p = <span>Promise</span>.resolve(obj)\n<span class=\"lineNumber\">9</span>p\n<span class=\"lineNumber\">10</span>\t.then(<span><span>r</span> =></span> <span>console</span>.log(<span>'resolve'</span>, r))\n<span class=\"lineNumber\">11</span>  .catch(<span><span>r</span> =></span> {\n<span class=\"lineNumber\">12</span>\t\t<span>console</span>.log(<span>'reject'</span>, r);\n<span class=\"lineNumber\">13</span>\t})\n<span class=\"lineNumber\">14</span> \n<span class=\"lineNumber\">15</span><span>// output</span>\n<span class=\"lineNumber\">16</span><span>this</span> is then [Arguments] {\n<span class=\"lineNumber\">17</span>  <span>'0'</span>: [<span>Function</span> (anonymous)],\n<span class=\"lineNumber\">18</span>  <span>'1'</span>: [<span>Function</span> (anonymous)]\n<span class=\"lineNumber\">19</span>}\n<span class=\"lineNumber\">20</span>reject <span>1</span></code></pre> \n\n<p>æ­¤å¤–,<code>Promise</code>ç±»è¿˜æœ‰å¦‚ä¸‹å‡ ä¸ªé™æ€æ–¹æ³•:</p>\n<ul>\n<li><code>Promise.all(iterable)</code></li>\n<li><code>Promise.race(iterable)</code></li>\n<li><code>Promise.any(iterable)</code></li>\n<li><code>Promise.allSettled(iterable)</code></li>\n</ul>\n<p>è¿™å‡ ä¸ªé™æ€æ–¹æ³•å„æœ‰å…¶åº”ç”¨åœºæ™¯.</p>\n<blockquote>\n<p>æ˜¯å¦æ”¯æŒè¿™äº›é™æ€æ–¹æ³•å–å†³äºå½“å‰ç¯å¢ƒ,ä¾‹å¦‚åœ¨<code>IE</code>æµè§ˆå™¨ä¸‹æ— æ³•ä½¿ç”¨<code>Promise</code>ï¼Œåœ¨<code>Node14</code>ä¸‹æ— æ³•ä½¿ç”¨<code>Promise.allSettled</code>ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“æ¥è¿›è¡Œæ›¿æ¢ï¼Œä¾‹å¦‚<code>bluebird</code>ã€‚</p>\n</blockquote>\n<h3>2.2.1 all</h3>\n<p>é¦–å…ˆ,<code>Promise.all(iterable)</code>æ–¹æ³•æ¥æ”¶ä¸€ä¸ª<code>iterable</code>å¯¹è±¡ï¼ˆé€šå¸¸æ˜¯æ•°ç»„ï¼‰ä½œä¸ºå‚æ•°,æœ€ç»ˆè¿”å›ä¸€ä¸ªæ–°çš„<code>promise å®ä¾‹</code>.</p>\n<blockquote>\n<p>å¦‚æœ<code>iterable</code>å¯¹è±¡æ˜¯ç©ºçš„,åˆ™è¿”å›çš„ç»“æœæ˜¯ç©ºæ•°ç»„(å°½ç®¡æˆ‘ä»¬ä¸å¤ªä¼šè¿™ä¹ˆåš).</p>\n</blockquote>\n<p>æˆ‘ä»¬é€šè¿‡ç¤ºä¾‹ä»£ç æ¥ç†è§£è§„èŒƒ:</p>\n<pre><code><span>let</span> p1 = <span>Promise</span>.all([\n<span class=\"lineNumber\">2</span>  <span>1</span>,\n<span class=\"lineNumber\">3</span>  <span>Promise</span>.resolve(<span>2</span>)\n<span class=\"lineNumber\">4</span>])</code></pre> \n\n<p>åˆæˆçš„<code>Promise</code>å°†åœ¨æ‰€æœ‰å†…éƒ¨<code>Promise</code>å®ä¾‹è½¬åŒ–ä¸º<code>Fulfilled</code>çŠ¶æ€åè½¬æ¢ä¸º<code>Fulfilled</code>çŠ¶æ€ï¼Œå…¶å€¼æ˜¯ä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡è½¬åŒ–ä¸º<code>Promise</code>è§£å†³ä¹‹åçš„å€¼çš„æ•°ç»„ã€‚</p>\n<blockquote>\n<p>å¯è¿­ä»£å¯¹è±¡å°†ä¼šé€šè¿‡<code>Promise.resolve</code>æ–¹æ³•è½¬æ¢ä¸º<code>Promise</code>å®ä¾‹ã€‚</p>\n</blockquote>\n<p>å¦‚æœä¸€æ—¦å…¶ä¸­ä¹‹ä¸€å‡ºç°<code>rejected</code>çŠ¶æ€çš„<code>promise å®ä¾‹</code>,åˆ™åˆæˆçš„<code>Promise</code>å®ä¾‹çš„çŠ¶æ€è½¬åŒ–ä¸º<code>rejected</code>,ä¸”å€¼ä¸ºæœ€å…ˆå‡ºç°çš„<code>rejected</code>çŠ¶æ€å®ä¾‹çš„å€¼.</p>\n<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>Promise.all</code>æ¥æ‰§è¡Œä¸€ç»„å¼‚æ­¥æ“ä½œ,è¿™äº›æ“ä½œçš„æ—¶é—´èŠ±è´¹å–å†³äºæœ€é•¿çš„é‚£ä¸ªå…ƒç´ ,å¹¶ä¸”æœ€ç»ˆå¦‚æœä¸€åˆ‡é¡ºåˆ©,åˆ™ç»“æœçš„é¡ºåºæ˜¯ä¸å˜çš„.</p>\n<p><code>Promise.all()</code>æ–¹æ³•é€‚ç”¨äº<code>åˆå¹¶è¯·æ±‚</code>çš„åœºæ™¯,ä¾‹å¦‚æŸäº›é¡¹ç›®ä¸­,æäº¤çš„å¤šä¸ªæ•°æ®éœ€è¦è°ƒç”¨äº‘ç«¯æ¥å£è¿›è¡Œæ•°æ®æ ¡éªŒ,å½“æ‰€æœ‰æ•°æ®éƒ½é€šè¿‡æ ¡éªŒçš„æ—¶å€™æ‰èƒ½æ‰§è¡Œä¸‹ä¸€æ­¥æ“ä½œ,æ¥çœ‹çœ‹ä»£ç :</p>\n<pre><code><span>// æœ‰ä¸€ä¸ªè¿”å› promise å¯¹è±¡çš„ asyncApi å‡½æ•°</span>\n<span class=\"lineNumber\">2</span><span>// æ¯ä¸€ä¸ª test å‡½æ•°éƒ½æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„æµ‹è¯•</span>\n<span class=\"lineNumber\">3</span><span>const</span> test = <span>(<span>value</span>) =></span> asyncApi(value)\n<span class=\"lineNumber\">4</span><span>Promise</span>.all([\n<span class=\"lineNumber\">5</span>  test(<span>'xxx'</span>),\n<span class=\"lineNumber\">6</span>  test(<span>'xx'</span>),\n<span class=\"lineNumber\">7</span>  test(<span>'x'</span>)\n<span class=\"lineNumber\">8</span>]).then(<span><span>results</span> =></span> {\n<span class=\"lineNumber\">9</span>  results.forEach(<span><span>result</span> =></span> {\n<span class=\"lineNumber\">10</span>    <span>// balabala ä½ çš„ä»£ç é€»è¾‘</span>\n<span class=\"lineNumber\">11</span>    <span>// éƒ½é€šè¿‡äº†</span>\n<span class=\"lineNumber\">12</span>  })\n<span class=\"lineNumber\">13</span>  <span>// do more...</span>\n<span class=\"lineNumber\">14</span>}).catch(<span><span>error</span> =></span> {\n<span class=\"lineNumber\">15</span>  <span>// å¤±è´¥çš„å€¼, balabala</span>\n<span class=\"lineNumber\">16</span>  <span>console</span>.log(error)\n<span class=\"lineNumber\">17</span>})</code></pre> \n\n<h3>2.2.2 race</h3>\n<p><code>Promise.race(iterable)</code>å¦‚å…¶å,ç±»ä¼¼äº<code>Promise.all()</code>,æ¥æ”¶åŒç±»å‹å‚æ•°,ä¸€æ—¦è¿­ä»£å™¨ä¸­æŸä¸ª<code>promise</code>çŠ¶æ€è½¬åŒ–ä¸º<code>settled</code>,ç«‹å³è¿”å›æ­¤<code>Promise</code>å®ä¾‹.</p>\n<blockquote>\n<p>ä¼ å…¥çš„è¿­ä»£ä¸ºç©ºçš„è¯,è¿”å›çš„<code>promise</code>å§‹ç»ˆ<code>pending</code>.</p>\n</blockquote>\n<p><code>Promise.race()</code>éå¸¸é€‚åˆåšå¼‚æ­¥è¯·æ±‚çš„<code>è¶…æ—¶</code>å¤„ç†.æ¥çœ‹ä¸€ä¸ªä¾‹å­:</p>\n<pre><code><span>// asyncApi() è¿”å› promise</span>\n<span class=\"lineNumber\">2</span><span><span>function</span> <span>timeout</span>(<span>ms</span>) </span>{\n<span class=\"lineNumber\">3</span>  <span>return</span> <span>new</span> <span>Promise</span>(<span>(<span>resolve, reject</span>) =></span> {\n<span class=\"lineNumber\">4</span>    <span>setTimeout</span>(<span>() =></span> {\n<span class=\"lineNumber\">5</span>      reject(<span>`timeout: <span>${ms}</span> ms`</span>)\n<span class=\"lineNumber\">6</span>    }, ms)\n<span class=\"lineNumber\">7</span>  })\n<span class=\"lineNumber\">8</span>}\n<span class=\"lineNumber\">9</span> \n<span class=\"lineNumber\">10</span><span>Promise</span>.race([\n<span class=\"lineNumber\">11</span>  asyncApi(<span>'xx'</span>),\n<span class=\"lineNumber\">12</span>  timeout(<span>5000</span>)\n<span class=\"lineNumber\">13</span>]).then(<span><span>res</span> =></span> {\n<span class=\"lineNumber\">14</span>  <span>// success</span>\n<span class=\"lineNumber\">15</span>}).catch(<span><span>error</span> =></span> {\n<span class=\"lineNumber\">16</span>  <span>// timeout or error</span>\n<span class=\"lineNumber\">17</span>})</code></pre> \n\n<h3>2.2.3 any</h3>\n<p><code>Promise.any(iterable)</code>æ˜¯<code>Promise.all()</code>çš„åé¢,å…¶è¯­æ³•æ— å¼‚.</p>\n<p>éœ€è¦æ³¨æ„çš„æ˜¯å¦‚æœä¼ å…¥çš„è¿­ä»£å™¨æ˜¯ç©ºçš„,åˆ™è¿”å›<code>rejected</code>çš„<code>promise </code>å®ä¾‹.åªè¦æœ‰ä¸€ä¸ªæˆåŠŸ,åˆ™è¿”å›æ­¤ç»“æœ.å¦‚æœè¿­ä»£å™¨å†…çš„<code>promise</code>å…¨éƒ¨è¿”å›<code>rejected</code>çŠ¶æ€,åˆ™æœ€ç»ˆè¿”å›<code>rejected</code>çš„<code>promise</code>å®ä¾‹.</p>\n<p>å› æ­¤,æ­¤æ–¹æ³•é€‚ç”¨äºéªŒè¯å¤šä¸ªå¼‚æ­¥ç»“æœä¸­æ˜¯å¦æœ‰<code>fulfilled</code>çš„<code>promise</code>å®ä¾‹.</p>\n<p>å¦‚æœæˆ‘ä»¬éœ€è¦å‘å¤šä¸ªæ•°æ®æºè·å–æŸä¸€ä¸ªæ•°æ®,åˆ™å¯ä»¥ä½¿ç”¨æ­¤æ–¹æ³•æœ€å¿«é€Ÿçš„è·å–åˆ°æ•°æ®,äº¦æˆ–è€…æ‰€æœ‰å¼‚æ­¥è¯·æ±‚éƒ½å¤±è´¥.</p>\n<h3>2.2.4 allSettled</h3>\n<p><code>Promise.allSettled(iterable)</code>æ–¹æ³•è¿”å›ä¸€ä¸ªåœ¨æ‰€æœ‰ç»™å®šçš„<code>promise</code>è½¬ä¸º<code>settled</code>çŠ¶æ€åçš„æ•°ç»„,æ•°ç»„å…ƒç´ æ˜¯æ¯ä¸€ä¸ª<code>promise</code>ç»“æœ.</p>\n<p>å¦‚æœæˆ‘ä»¬æœ‰å¤šä¸ªäº’ä¸ä¾èµ–çš„<code>å¼‚æ­¥ä»»åŠ¡</code>,æˆ–è€…æˆ‘ä»¬æ€»æƒ³çŸ¥é“æ¯ä¸ª<code>promise</code>çš„ç»“æœ,è€Œä¸éœ€è¦å…¶ä¸­çš„<code>rejected</code>çŠ¶æ€<code>promise</code>å»å¼•å‘<code>catch</code>,æ¥çœ‹çœ‹<code>MDN</code>çš„ä¾‹å­:</p>\n<pre><code><span>const</span> promise1 = <span>Promise</span>.resolve(<span>3</span>);\n<span class=\"lineNumber\">2</span><span>const</span> promise2 = <span>new</span> <span>Promise</span>(<span>(<span>resolve, reject</span>) =></span> <span>setTimeout</span>(reject, <span>100</span>, <span>'foo'</span>));\n<span class=\"lineNumber\">3</span><span>const</span> promises = [promise1, promise2];\n<span class=\"lineNumber\">4</span> \n<span class=\"lineNumber\">5</span><span>Promise</span>.allSettled(promises).\n<span class=\"lineNumber\">6</span>  then(<span>(<span>results</span>) =></span> results.forEach(<span>(<span>result</span>) =></span> <span>console</span>.log(result)));</code></pre> \n\n<p>è¾“å‡ºæ˜¯:</p>\n<pre><code><span>></span><span> Object { status: <span>\"fulfilled\"</span>, value: 3 }</span>\n<span class=\"lineNumber\">2</span><span>></span><span> Object { status: <span>\"rejected\"</span>, reason: <span>\"foo\"</span> }</span></code></pre> \n\n<p>å¦‚ä¸Šæ‰€ç¤º,çŠ¶æ€ä¸º<code>fulfilled</code>æ—¶,å…·æœ‰<code>value</code>,çŠ¶æ€ä¸º<code>rejected</code>æ—¶,å…·æœ‰<code>reason</code>.</p>\n<p>è¿˜è®°å¾—æˆ‘ä»¬åœ¨<code>Promise.all()</code>ä¸­çš„è¿­ä»£å™¨è¿”å›çš„æ˜¯<code>promise.catch(err => err)</code>å—?å…¶å®,ä½¿ç”¨<code>Promise.allSettled()</code>ç›¸å¯¹æ›´å¥½.</p>\n<h2>2.3 Promise çš„ä¼˜åŠ£</h2>\n<p><code>Promise</code>çš„å‡ºç°ä¿ƒè¿›äº†<code>å¼‚æ­¥</code>ç¼–ç¨‹çš„å‘å±•,æˆ‘ä»¬å¯ä»¥åœ¨æµè§ˆå™¨ç«¯å’Œ<code>node</code>ç«¯çœ‹åˆ°ç»Ÿä¸€çš„<code>Promise</code>ä»£ç .è¿˜è®°å¾—<code>callback</code>å›è°ƒå‡½æ•°çš„å‚æ•°çº¦å®šå—?</p>\n<pre><code><span><span>function</span> <span>foo</span>(<span>param, (err, data) => {\n<span class=\"lineNumber\">2</span>  <span>if</span>(err) {\n<span class=\"lineNumber\">3</span>    <span>//</span> balabala\n<span class=\"lineNumber\">4</span>  }\n<span class=\"lineNumber\">5</span>  <span>//</span> balabala\n<span class=\"lineNumber\">6</span>}</span>)</span></code></pre> \n\n<p>è¿™ç§å‚æ•°çº¦å®šæ˜¯è„†å¼±çš„,å¼€å‘è€…å¯ä»¥ä¸æŒ‰æ­¤çº¦å®šç¼–å†™å›è°ƒå‡½æ•°,è¿™ç±»éšè—<code>bug</code>å¯èƒ½å°±æ­¤è€Œç”Ÿ.</p>\n<p><code>Promise</code>çš„å‡ºç°,æˆ‘ä»¬å¿…é¡»ä½¿ç”¨å…¶å®ä¾‹æ–¹æ³•<code>then</code>å’Œ<code>catch</code>å»æŒ‰è§„èŒƒç¼–ç ,å¦åˆ™å°†ä¼šå‡ºé”™,å¼€å‘è€…ä¹Ÿå¯ä»¥çœ‹åˆ°æ˜æ˜¾çš„é”™è¯¯æç¤ºä¿¡æ¯.</p>\n<p>æˆ‘ä»¬å†æ¥çœ‹çœ‹å¦‚ä¸‹ä¸¤ä¸ªä¾‹å­:</p>\n<pre><code><span>// callback</span>\n<span class=\"lineNumber\">2</span>fs.readFile(name, opts?, <span>(<span>err, string|Buffer</span>) =></span> <span>void</span>)\n<span class=\"lineNumber\">3</span><span>// Promise</span>\n<span class=\"lineNumber\">4</span>readFilePromisified(name, opts?): <span>Promise</span>&#x3C;string | Buffer></code></pre> \n\n<p><code>Promise</code>æ–¹æ¡ˆè®©å‡½æ•°å‚æ•°å’Œå›è°ƒè§£è€¦å¼€æ¥,æ‰€æœ‰çš„å‚æ•°éƒ½ç”¨äºæ­¤å‡½æ•°çš„è¾“å…¥.</p>\n<p><code>Promise</code>åœ¨å¤„ç†å•æ¬¡å¼‚æ­¥ä»»åŠ¡çš„æ—¶å€™è¡¨ç°è‰¯å¥½,ä½†æ˜¯å¯¹äºå¤šæ¬¡è§¦å‘çš„ä»»åŠ¡ä¾¿æ˜¾å¾—ä¹åŠ›,ä¹Ÿè®¸æˆ‘ä»¬éœ€è¦å­¦ä¹ ä¸€äº›<code>å“åº”å¼ç¼–ç¨‹</code>æŠ€æœ¯,ä»¥è§£å†³æ­¤ç±»é—®é¢˜.</p>\n<p>å¯¹äº<code>ES6 Promise</code>æ¥è¯´,ç¼ºä¹ä¸¤é¡¹å¾ˆå®ç”¨çš„åŠŸèƒ½:</p>\n<ul>\n<li>å–æ¶ˆä»»åŠ¡(åœ¨ç»„ä»¶è¢«åˆ é™¤åå–æ¶ˆå¼‚æ­¥ä»»åŠ¡ç­‰)ï¼ŒTC39 å§”å‘˜ä¼šå®é™…ä¸Šå‡†å¤‡å¢åŠ æ­¤ç‰¹æ€§ï¼Œä½†æœ€ç»ˆææ¡ˆè¢«æ’¤å›äº†ï¼Œä½†æ˜¯æ²¡å…³ç³»ï¼Œ<code>Bluebird</code>å®ç°äº†æ­¤åŠŸèƒ½ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å¯¹æ­¤ç‰¹æ€§è¿›è¡Œè¡¥å……ï¼Œä¾‹å¦‚åˆ©ç”¨<code>setTimeout</code>å®šæ—¶å™¨å‡½æ•°å¯ä»¥è¢«å–æ¶ˆçš„ç‰¹æ€§ï¼Œç¼–å†™ä¸€äº›é€»è¾‘ä»£ç å’Œ<code>Promise</code>å–æ¶ˆçŠ¶æ€è½¬æ¢çš„åŠŸèƒ½å‡½æ•°ã€‚</li>\n<li>è¿›åº¦è¿½è¸ª(æ˜¾ç¤ºè¿›åº¦æ¡ç­‰)ï¼ŒåŸç”Ÿä¸æ”¯æŒæ­¤ç‰¹æ€§çš„åŸå› æ˜¯æ‹…å¿ƒæ­¤ç‰¹æ€§ä¼šå¯¼è‡´<code>Promise</code>çš„é“¾å¼è°ƒç”¨å’Œç±»ä¼¼<code>all</code>é™æ€æ–¹æ³•çš„å¤æ‚åº¦å¢åŠ ã€‚</li>\n</ul>\n<p>åŸç”Ÿ<code>Promise</code>æš‚æœªæ”¯æŒä¸Šè¿°ä¸¤é¡¹ç‰¹æ€§,ä¹Ÿè®¸æˆ‘ä»¬å¯ä»¥çœ‹çœ‹ç±»ä¼¼<code>Bluebird</code>è¿™æ ·çš„ç¬¬ä¸‰æ–¹åº“ï¼Œå®ƒä»¬åŠŸèƒ½å¼ºå¤§å¹¶ä¸”è¢«å¹¿æ³›ä½¿ç”¨ï¼Œå€¼å¾—ä¿¡èµ–ã€‚</p>\n<h1>3. async / await</h1>\n<p>æåŠå¼‚æ­¥å‡½æ•°ï¼Œ<code>async/await</code>è¯­æ³•å…³é”®å­—ä¸€å®šæ˜¯ç»•ä¸å¼€çš„çŸ¥è¯†ç‚¹ï¼Œè¿™æ˜¯ä¸€ç§ä½¿ç”¨ <code>Promise</code>çš„ç‰¹æ®Šè¯­æ³•ï¼Œå¹¶ä¸”éå¸¸å®¹æ˜“ç†è§£å’Œä½¿ç”¨ã€‚</p>\n<p>æˆ‘ä»¬ç›´æ¥çœ‹ç¤ºä¾‹ï¼š</p>\n<pre><code><span>async</span> <span><span>function</span> <span>foo</span>(<span></span>) </span>{\n<span class=\"lineNumber\">2</span>  <span>// balabala</span>\n<span class=\"lineNumber\">3</span>  <span>return</span> <span>1</span>;\n<span class=\"lineNumber\">4</span>}</code></pre> \n\n<blockquote>\n<p>å¯ä»¥ç†è§£ä¸º async å‡½æ•°æœ€åæ˜¾å¼è¿”å›çš„å€¼ç»è¿‡ Promise.resolve å‡½æ•°çš„è½¬åŒ–ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„ Promise å®ä¾‹</p>\n</blockquote>\n<p>åœ¨å‡½æ•°å‰æ·»åŠ <code>async</code>æ ‡è¯†æ­¤å‡½æ•°æ€»æ˜¯è¿”å›ä¸€ä¸ª<code>Promise</code>å®ä¾‹,å³ä½¿æˆ‘ä»¬æ˜¾ç¤ºæŒ‡å®šå…¶ä»–çš„ç±»å‹å€¼çš„è¿”å›å€¼ï¼Œä¹Ÿä¼šè¢«åŒ…è£…æˆä¸€ä¸ª<code>Promise</code>å¹¶è¿”å›ï¼Œå½“ç„¶ï¼Œä¾ç„¶æ¨èæ˜¾ç¤ºåœ°æŒ‡å®šè¿”å›<code>Promise</code>ã€‚</p>\n<p>ä½¿ç”¨<code>async</code>å…³é”®å­—å¯ä»¥è®©å‡½æ•°å…·æœ‰<code>å¼‚æ­¥</code>ç‰¹å¾ï¼Œä½†æ€»ä½“ä¸Šä»£ç ä¾ç„¶æ˜¯<code>åŒæ­¥</code>æ±‚å€¼çš„ã€‚</p>\n<p>ä¸¾ä¸ªä¾‹å­ï¼š</p>\n<pre><code><span>async</span> <span><span>function</span> <span>foo</span>(<span></span>) </span>{\n<span class=\"lineNumber\">2</span>  <span>console</span>.log(<span>1</span>)\n<span class=\"lineNumber\">3</span>}\n<span class=\"lineNumber\">4</span>foo()\n<span class=\"lineNumber\">5</span><span>console</span>.log(<span>2</span>)\n<span class=\"lineNumber\">6</span><span>// output</span>\n<span class=\"lineNumber\">7</span><span>1</span>\n<span class=\"lineNumber\">8</span><span>2</span></code></pre> \n\n<blockquote>\n<p>å¼‚æ­¥å‡½æ•°å…·æœ‰æš‚åœå’Œæ¢å¤æ‰§è¡Œçš„åŠŸèƒ½æ˜¯ååˆ†å¿…è¦çš„ã€‚</p>\n</blockquote>\n<p>ä½¿ç”¨<code>await</code>å…³é”®å­—å¯ä»¥æš‚åœå¼‚æ­¥å‡½æ•°çš„æ‰§è¡Œå¹¶ä¸”ç­‰å¾…è¿”å›çš„<code>Promise</code>å®ä¾‹è¿›å…¥<code>settled</code>çŠ¶æ€ã€‚</p>\n<p>å…³é”®è¯<code>await</code>åªåœ¨<code>async</code>å‡½æ•°å†…æœ‰æ•ˆï¼š</p>\n<pre><code><span>async</span> <span><span>function</span> <span>foo</span>(<span></span>) </span>{\n<span class=\"lineNumber\">2</span>  <span>const</span> res = <span>await</span> axios.get(<span>'your url'</span>)\n<span class=\"lineNumber\">3</span>}</code></pre> \n\n<p>åœ¨æ—¥å¸¸å·¥ä½œä¸­æ— è®ºæ˜¯æµè§ˆå™¨è¿˜æ˜¯<code>Nodejs</code>ï¼Œéƒ½å¯ä»¥çœ‹åˆ°<code>await</code>çš„èº«å½±ã€‚</p>\n<p>é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬æ›´æ¨èä½¿ç”¨<code>async/await</code>è¯­æ³•ï¼Œå®ƒåˆæœ‰æ€æ ·çš„ç»†èŠ‚éœ€è¦æˆ‘ä»¬å…³æ³¨çš„å‘¢ï¼Ÿ</p>\n<p>æ¥çœ‹ä»¥ä¸‹å‡ ç‚¹ç‰¹æ€§ï¼š</p>\n<ul>\n<li>é¡¶å±‚<code>await</code>ï¼šæ­¤ææ¡ˆå½“å‰ä¾ç„¶æ˜¯ <code>stage 3</code>ï¼Œåœ¨æ­£å¼è¿›å…¥ç¨³å®šç‰ˆä¹‹å‰ï¼Œé¡¶å±‚å¯¹äº<code>await</code>çš„ä½¿ç”¨ä¾ç„¶éœ€è¦ç«‹å³æ‰§è¡Œè¡¨è¾¾å¼ï¼ˆIIFEï¼‰ï¼Œä¸å¹¸çš„æ˜¯ï¼Œè¿™ç§æ¨¡å¼å¯¼è‡´å›¾å½¢æ‰§è¡Œå’Œåº”ç”¨ç¨‹åºçš„é™æ€å¯åˆ†ææ€§çš„ç¡®å®šæ€§é™ä½ã€‚ç”±äºè¿™äº›åŸå› ï¼Œç¼ºå°‘é¡¶å±‚ <code>await</code> è¢«è®¤ä¸ºæ¯”è¯¥åŠŸèƒ½å¸¦æ¥çš„å±å®³æœ‰æ›´é«˜çš„é£é™©ã€‚</li>\n<li>é¡¶å±‚ <code>await</code> ä»…é™äº ES æ¨¡å—ã€‚æ˜ç¡®ä¸æ”¯æŒ<code>CommonJS</code>æ¨¡å—ã€‚</li>\n<li><code>await</code>æ”¯æŒ<code>thenable</code>å¯¹è±¡,å¦‚æœå…¶åæ˜¯ä¸€ä¸ª<code>thenable</code>å¯¹è±¡ï¼Œåˆ™ä¼šæ‰§è¡Œæ­¤å¯¹è±¡çš„<code>then</code>æ–¹æ³•ï¼Œå¹¶ä¸”ä¼ å…¥<code>resolve</code>å’Œ<code>reject</code>å‡½æ•°ä½œä¸ºå‚æ•°ï¼Œæœ€ç»ˆå¾—åˆ°ä¸€ä¸ª<code>settled</code>çš„<code>Promise</code>å®ä¾‹ã€‚</li>\n<li><code>await</code>å’Œ<code>Promise.all</code>ç­‰é™æ€æ–¹æ³•é…åˆè‰¯å¥½ã€‚</li>\n</ul>\n<pre><code><span>const</span> res = <span>await</span> <span>Promise</span>.all([\n<span class=\"lineNumber\">2</span>  promise1,\n<span class=\"lineNumber\">3</span>  promise2,\n<span class=\"lineNumber\">4</span>  ...\n<span class=\"lineNumber\">5</span>])</code></pre> \n\n<ul>\n<li>Error å¤„ç†</li>\n</ul>\n<blockquote>\n<p><code>async/await</code>é…åˆ<code>try...catch..</code>å¯ä»¥æ›´æ¸…æ™°åœ°åŒæ—¶å¤„ç†åŒæ­¥å’Œå¼‚æ­¥çš„å¼‚å¸¸</p>\n</blockquote>\n<p>è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š</p>\n<pre><code><span>const</span> makeRequest = <span>async</span> () => {\n<span class=\"lineNumber\">2</span>  <span>try</span> {\n<span class=\"lineNumber\">3</span>    <span>const</span> data = <span>JSON</span>.parse(<span>await</span> getJSON())\n<span class=\"lineNumber\">4</span>    <span>console</span>.log(data)\n<span class=\"lineNumber\">5</span>  } <span>catch</span> (e) {\n<span class=\"lineNumber\">6</span>    <span>console</span>.log(e)\n<span class=\"lineNumber\">7</span>  }\n<span class=\"lineNumber\">8</span>}</code></pre> \n\n<p>æ— è®ºæ˜¯å¼‚æ­¥å‡½æ•°<code>getJSON()</code>è¿˜æ˜¯åŒæ­¥å‡½æ•°<code>JSON.parse()</code>éƒ½èƒ½è¢«åŒä¸€ä¸ª<code>try...catch...</code>ç»“æ„å¯¹å¼‚å¸¸è¿›è¡Œå¤„ç†ï¼Œä»£ç é€»è¾‘ç›¸å¯¹ä½¿ç”¨<code>Promise.then / catch</code>çš„æ–¹å¼æ¥è¯´ä¼šæ›´æ¸…æ™°ï¼Œå¯è¯»æ€§æ›´å¼ºã€‚</p>\n<p>ä¹Ÿè®¸å¯è¯»æ€§çš„è¯„åˆ¤æ›´å®¹æ˜“æºæ‚ä¸»è§‚æ„è¯†ï¼Œä½†æ˜¯å¯¹äºå¼‚æ­¥<code>Debug</code>ä»£ç æ¥è¯´ï¼Œ<code>async/await</code>æ˜¾ç„¶æ›´è½»æ¾ã€‚</p>\n<p>ä¸ºä»€ä¹ˆï¼Ÿæˆ‘æƒ³æœ‰ä»¥ä¸‹ä¸¤ç‚¹ç†ç”±ï¼š</p>\n<ul>\n<li>åœ¨<code>then</code>ä¸­éš¾ä»¥å¯¹ç®­å¤´å‡½æ•°ä¸‹æ–­ç‚¹</li>\n<li>å³ä½¿æ˜¯åœ¨ <code>then</code>ä¸­ä¸‹äº†æ–­ç‚¹ï¼Œç±»ä¼¼å•æ­¥æ­¥å…¥çš„æ“ä½œä¹Ÿä¸ä¼šå¾—åˆ°é¢„æœŸçš„ç»“æœï¼ŒåŸå› åœ¨äºè¿™ç§è°ƒè¯•æ–¹å¼åªèƒ½åœ¨åŒæ­¥ä»£ç ä¸­ä½¿ç”¨ã€‚</li>\n</ul>\n<p>æˆ‘ä»¬æ¥çœ‹ä¸¤ä¸ªç¤ºä¾‹ï¼š</p>\n<pre><code><span>const</span> makeRequest = <span>() =></span> {\n<span class=\"lineNumber\">2</span>   <span>return</span> callAPromise()\n<span class=\"lineNumber\">3</span>     .then(<span>() =></span> callAPromise())\n<span class=\"lineNumber\">4</span>     .then(<span>() =></span> callAPromise())\n<span class=\"lineNumber\">5</span>}\n<span class=\"lineNumber\">6</span><span>// async / await</span>\n<span class=\"lineNumber\">7</span><span>const</span> makeRequest = <span>async</span>() => {\n<span class=\"lineNumber\">8</span>   <span>await</span> callAPromise()\n<span class=\"lineNumber\">9</span>   <span>await</span> callAPromise()\n<span class=\"lineNumber\">10</span>}</code></pre> \n\n<p>åœ¨è°ƒè¯•è¿‡ç¨‹ä¸­ç”±äº<code>await</code>çš„ç‰¹æ®Šæ€§ï¼Œæˆ‘ä»¬å¯ä»¥åƒè°ƒè¯•åŒæ­¥ä»£ç è¿™ä¹ˆæ–¹ä¾¿è‡ªç„¶ã€‚</p>\n<blockquote>\n<p>å¦å¤–ï¼Œä½¿ç”¨<code>async / await</code>è¯­æ³•ï¼Œæˆ‘ä»¬åº”è¯¥ç•™å¿ƒå¼‚æ­¥ä»£ç çš„å¹³è¡ŒåŠ é€Ÿé—®é¢˜ã€‚</p>\n</blockquote>\n<p>æ¥çœ‹ç¤ºä¾‹ï¼š</p>\n<pre><code><span>async</span> <span><span>function</span> <span>delay</span>(<span>id</span>) </span>{\n<span class=\"lineNumber\">2</span>  <span>return</span> <span>new</span> <span>Promise</span>(<span>(<span>res</span>) =></span> {\n<span class=\"lineNumber\">3</span>    <span>setTimeout</span>(<span>() =></span> {\n<span class=\"lineNumber\">4</span>      <span>console</span>.log(<span>`task <span>${id}</span> finished.`</span>)\n<span class=\"lineNumber\">5</span>    }, <span>1000</span>)\n<span class=\"lineNumber\">6</span>  })\n<span class=\"lineNumber\">7</span>}\n<span class=\"lineNumber\">8</span><span>async</span> <span><span>function</span> <span>demo1</span>(<span></span>) </span>{\n<span class=\"lineNumber\">9</span>  <span>await</span> delay(<span>1</span>)\n<span class=\"lineNumber\">10</span>  <span>await</span> delay(<span>2</span>)\n<span class=\"lineNumber\">11</span>  <span>await</span> delay(<span>3</span>)\n<span class=\"lineNumber\">12</span>}\n<span class=\"lineNumber\">13</span>demo1()\n<span class=\"lineNumber\">14</span><span>// å¦ä¸€ä¸ª demo</span>\n<span class=\"lineNumber\">15</span><span>async</span> <span><span>function</span> <span>demo2</span>(<span></span>) </span>{\n<span class=\"lineNumber\">16</span>  <span>const</span> p1 = delay(<span>1</span>)\n<span class=\"lineNumber\">17</span>  <span>const</span> p2 = delay(<span>2</span>)\n<span class=\"lineNumber\">18</span>  <span>const</span> p3 = delay(<span>3</span>)\n<span class=\"lineNumber\">19</span>  <span>await</span> p1\n<span class=\"lineNumber\">20</span>  <span>await</span> p2\n<span class=\"lineNumber\">21</span>  <span>await</span> p3\n<span class=\"lineNumber\">22</span>}</code></pre> \n\n<p>å¯¹äºæ²¡æœ‰å¼‚æ­¥æ‰§è¡Œé¡ºåºéœ€æ±‚çš„<code>async/await</code>è¯­æ³•æ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥ä¸€æ¬¡æ€§åˆå§‹åŒ–å…¶å¼‚æ­¥ä»»åŠ¡ï¼Œç„¶åå†åˆ†åˆ«ç­‰å¾…å…¶ç»“æœå³å¯ã€‚</p>\n<blockquote>\n<p>åœ¨é‡è§†<code>æ€§èƒ½</code>çš„åº”ç”¨ä¸­ï¼Œä½¿ç”¨<code>async/await</code>è¯­æ³•å¯ä»¥å‡å°‘å†…å­˜çš„å ç”¨ã€‚</p>\n</blockquote>\n<p>åœ¨ä½¿ç”¨<code>new Promise</code>åˆå§‹åŒ–æ—¶ï¼Œæˆ‘ä»¬åˆ›å»º<code>Promise</code>å®ä¾‹çš„å‡½æ•°å³ä½¿æ˜¯åœ¨å¤„ç†ç¨‹åºè½¬æ¢<code>Promise</code>å®ä¾‹çš„çŠ¶æ€æ—¶ä¾ç„¶è¢«ä¿å­˜åœ¨æ ˆè¿½è¸ªä¿¡æ¯å†…ï¼Œç„¶è€Œæˆ‘ä»¬çŸ¥é“è¿™äº›ä¿¡æ¯éšç€åˆå§‹åŒ–å‡½æ•°çš„è¿”å›å…¶å®å·²ç»æ²¡æœ‰å¿…è¦å­˜åœ¨äº†ï¼Œä½†æ˜¯<code>Javascript</code>å¼•æ“ä¼šåœ¨åˆ›å»º<code>Promise</code>æ—¶å°½å¯èƒ½ä¿å­˜å®Œæ•´çš„è°ƒç”¨æ ˆï¼Œåœ¨æŠ›å‡ºé”™è¯¯æ—¶è°ƒç”¨æ ˆå¯ä»¥ç”±è¿è¡Œæ—¶çš„é”™è¯¯å¤„ç†é€»è¾‘è·å–ï¼Œæ•…æˆ‘ä»¬èƒ½åœ¨æ ˆè¿½è¸ªä¿¡æ¯ä¸­çœ‹åˆ°å®ƒä»¬ï¼Œæœ€ç»ˆå ç”¨ä¸€äº›å†…å­˜ï¼Œå¢åŠ äº†è®¡ç®—å’Œå­˜å‚¨æˆæœ¬ã€‚</p>\n<p>å¦‚æœæˆ‘ä»¬ä½¿ç”¨<code>async/await</code>è¯­æ³•ï¼š</p>\n<pre><code><span><span>function</span> <span>fooPromiseExecutor</span>(<span>resolve, reject</span>) </span>{\n<span class=\"lineNumber\">2</span>  <span>setTimeout</span>(reject, <span>1000</span>, <span>'bar'</span>)\n<span class=\"lineNumber\">3</span>}\n<span class=\"lineNumber\">4</span> \n<span class=\"lineNumber\">5</span><span>async</span> <span><span>function</span> <span>foo</span>(<span></span>) </span>{\n<span class=\"lineNumber\">6</span>  <span>await</span> <span>new</span> <span>Promise</span>(fooPromiseExecutor)\n<span class=\"lineNumber\">7</span>}\n<span class=\"lineNumber\">8</span>foo()\n<span class=\"lineNumber\">9</span><span>/// Uncaught (in promise) bar</span>\n<span class=\"lineNumber\">10</span><span>// foo</span>\n<span class=\"lineNumber\">11</span><span>// async function (async)</span>\n<span class=\"lineNumber\">12</span><span>// foo</span></code></pre> \n\n<p>ç”±äº<code>fooPromiseExecutor</code>å·²ç»è¿”å›ï¼Œæ•…ä¸åœ¨é”™è¯¯ä¿¡æ¯ä¸­äº†ã€‚</p>\n<p><code>Javascript</code>è¿è¡Œæ—¶å¯ä»¥ç®€å•åœ°åœ¨åµŒå¥—å‡½æ•°ä¸­å­˜å‚¨æŒ‡å‘åŒ…å«å‡½æ•°çš„æŒ‡é’ˆï¼Œå°±å¦‚åŒå¯¹å¾…åŒæ­¥å‡½æ•°ä¸€æ ·ï¼ŒæŒ‡é’ˆæ—¶æœºå­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œç”¨äºåœ¨å‡ºé”™çš„æ—¶å€™ç”Ÿæˆé”™è¯¯ä¿¡æ¯ï¼Œå¦‚æ­¤ä¸€æ¥ä¾¿çœå»äº†è¿™â€œå¾®å°â€çš„æ¶ˆè€—ã€‚</p>\n<p>æœ€åæˆ‘æƒ³è¯´ï¼Œç›¸å¯¹äºä½¿ç”¨<code>Promise</code>çš„å®ä¾‹æ–¹æ³•æ¥ç¼–å†™å¼‚æ­¥ä»£ç ï¼Œä½¿ç”¨<code>async/await</code>çš„è¯­æ³•ï¼Œæ˜¾ç„¶ä»£ç é‡å°†ä¼šå‡å°‘ğŸ¶ï¼Œä½•ä¹è€Œä¸ä¸ºï¼Ÿ</p>\n<h1>4. Promisify</h1>\n<p><code>Promise</code>å¾ˆæ£’ï¼Œä½†æ˜¯éµå¾ªå¸¸è§çš„é”™è¯¯ä¼˜å…ˆçš„å›è°ƒé£æ ¼çš„å‡½æ•°ä¾ç„¶å¯ä»¥åœ¨è®¸å¤šåœºæ™¯ä¸‹æ´»è·ƒç€ï¼Œæ— è®ºæ˜¯å…¶å¼€å‘è€…åœ¨ç¼–å†™ä»£ç çš„æ—¶å€™è¿˜æœªå‡ºç°<code>Promise</code>ï¼Œäº¦æˆ–æ˜¯å¼€å‘è€…æ›´å–œæ¬¢å›è°ƒé£æ ¼çš„èŒƒå¼ï¼Œè·Ÿè¿™äº›å›è°ƒé£æ ¼çš„å‡½æ•°æ‰“äº¤é“ä¼¼ä¹æ— å¯é¿å…ã€‚</p>\n<blockquote>\n<p>Nodejs å®˜æ–¹æä¾›äº† util.promisify å·¥å…·å‡½æ•°ç”¨äºå°†ä¼ ç»Ÿå›è°ƒé£æ ¼çš„å‡½æ•°è½¬æ¢ä¸ºè¿”å›<code>Promise</code>çš„å‡½æ•°ã€‚</p>\n</blockquote>\n<p>æˆ‘ä»¬å¯ä»¥æ„å»ºä¸€ä¸ªå°†<code>callback</code>é£æ ¼çš„å‡½æ•°è½¬æ¢ä¸º<code>Promise</code>é£æ ¼çš„å‡½æ•°çš„å·¥å…·å‡½æ•°ã€‚</p>\n<pre><code><span><span>function</span> <span>promisify</span>(<span>f, multiArgs = <span>false</span></span>)</span>{\n<span class=\"lineNumber\">2</span>  <span>return</span> <span><span>function</span>(<span>...args</span>) </span>{\n<span class=\"lineNumber\">3</span>    <span>return</span> <span>new</span> <span>Promise</span>(<span>(<span>resolve, reject</span>) =></span> {\n<span class=\"lineNumber\">4</span>      <span><span>function</span> <span>callback</span>(<span>err, ...results</span>) </span>{\n<span class=\"lineNumber\">5</span>        err ? reject(err) : resolve(multiArgs ? results : results[<span>0</span>])\n<span class=\"lineNumber\">6</span>      }\n<span class=\"lineNumber\">7</span>      args.push(callback)\n<span class=\"lineNumber\">8</span>      f.call(<span>this</span>, ...args)\n<span class=\"lineNumber\">9</span>    })\n<span class=\"lineNumber\">10</span>  }\n<span class=\"lineNumber\">11</span>}\n<span class=\"lineNumber\">12</span> \n<span class=\"lineNumber\">13</span><span>const</span> fs = <span>require</span>(<span>'fs'</span>)\n<span class=\"lineNumber\">14</span><span>const</span> fsPromise = promisify(fs.readdir)\n<span class=\"lineNumber\">15</span>fsPromise(<span>'.'</span>).then(<span><span>r</span> =></span> {\n<span class=\"lineNumber\">16</span>  <span>console</span>.log(<span>'resolve'</span>, r);\n<span class=\"lineNumber\">17</span>}).catch(<span><span>r</span> =></span> {\n<span class=\"lineNumber\">18</span>  <span>console</span>.log(<span>'reject'</span>, r);\n<span class=\"lineNumber\">19</span>})\n<span class=\"lineNumber\">20</span><span>// output</span>\n<span class=\"lineNumber\">21</span>resolve [\n<span class=\"lineNumber\">22</span>  <span>'index.js'</span>\n<span class=\"lineNumber\">23</span>]</code></pre> \n\n<p>åœ¨è¿™ä¸ªè½¬æ¢è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†åŸæ¥çš„å‡½æ•°åŒ…è£¹è¿›å»ï¼Œå¹¶ä¸”è¿”å›ä¸€ä¸ªå¯æ‰§è¡Œçš„å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ¥æ”¶çš„å‚æ•°è·ŸåŸæ¥çš„<code>å›è°ƒé£æ ¼</code>å‡½æ•°ä¸€è‡´ï¼Œåªæ˜¯å°†ä¹‹è½¬æ¢ä¸º<code>Promise</code>é£æ ¼çš„å‡½æ•°åï¼Œä¼ å‚å¯ä»¥çœç•¥<code>å›è°ƒå‡½æ•°</code>ï¼Œæˆ‘ä»¬åœ¨å†…éƒ¨æ„å»ºäº†ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå¹¶ä¸”å°†ä¹‹ä½œä¸ºåŸå‡½æ•°çš„å›è°ƒéƒ¨åˆ†ä½œä¸ºå‚æ•°ä¼ ç»™äº†è¿”å›å‡½æ•°ã€‚</p>\n<p>ç°åœ¨ï¼Œæˆ‘ä»¬å°†ä¼ ç»Ÿå›è°ƒé£æ ¼çš„å‡½æ•°è½¬åŒ–ä¸ºè¿”å›<code>Promise</code>çš„å‡½æ•°äº†ï¼Œæˆ‘ä»¬å¯ä»¥æ”¾å¿ƒä½¿ç”¨<code>Promise</code>çš„æ–°ç‰¹æ€§äº†ã€‚</p>\n<h1>å‚è€ƒ</h1>\n<ul>\n<li><a>Exploring ES6 - exploring-es6.pdf</a></li>\n<li><a href=\"https://stackoverflow.com/questions/2069763/difference-between-event-handlers-and-callbacks\">architecture - Difference between event handlers and callbacks - Stack Overflow</a></li>\n<li><a href=\"https://stackoverflow.com/questions/6348494/addeventlistener-vs-onclick\">javascript - addEventListener vs onclick - Stack Overflow</a></li>\n<li><a href=\"http://bluebirdjs.com/docs/getting-started.html\">Getting Started | bluebird</a></li>\n<li>JavaScript é«˜çº§ç¨‹åºè®¾è®¡</li>\n<li><a href=\"https://zh.javascript.info/\">ç°ä»£ JavaScript æ•™ç¨‹</a></li>\n<li><a href=\"https://www.geeksforgeeks.org/javascript-promise-resolve-method/\">JavaScript | promise resolve() Method - GeeksforGeeks</a></li>\n<li><a href=\"https://itnext.io/error-handling-with-async-await-in-js-26c3f20bc06a\">Error handling with Async/Await in JS | by Ian Segers | ITNEXT</a></li>\n<li><a href=\"https://nodejs.dev/learn/understanding-javascript-promises\">Understanding JavaScript Promises</a></li>\n<li><a href=\"http://nodejs.cn/api/util/util_promisify_original.html\">util.promisify(original) | Node.js API æ–‡æ¡£</a></li>\n</ul>\n","title":"Javascript,I promise - å¼‚æ­¥ç¼–ç¨‹","date":"2021/4/9","tags":["JavaScript"],"mainImg":"https://images.unsplash.com/photo-1611923973164-e0e5f7f69872?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=MnwxNjUyNjZ8MHwxfHJhbmRvbXx8fHx8fHx8fDE2MTc5NzU1MTI&ixlib=rb-1.2.1&q=80&w=1080","coverImg":"https://images.unsplash.com/photo-1611923973164-e0e5f7f69872?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=MnwxNjUyNjZ8MHwxfHJhbmRvbXx8fHx8fHx8fDE2MTc5NzU1MTI&ixlib=rb-1.2.1&q=80&w=400","intro":"Promise, JavaScript ä¸–ç•Œä¸­çš„å¼‚æ­¥å¤„ç†å¯¹è±¡.æˆ‘é˜…è¯»äº† Dr.Axel å‰è¾ˆçš„ç”µå­ä¹¦,å……æ»¡æ„Ÿæ¿€."}},"__N_SSG":true}