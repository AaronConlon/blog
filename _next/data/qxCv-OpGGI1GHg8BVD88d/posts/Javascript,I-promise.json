{"pageProps":{"post":{"slug":"Javascript,I-promise","contentHtml":"<p>è™½ç„¶æ­¤å‰æˆ‘å·²ç»æ¥è§¦è¿‡ä¸€äº›å¼‚æ­¥ç¼–ç¨‹çš„æ¦‚å¿µ,å¹¶ä¸”æœ‰è¿‡ä¸€å®šçš„å®é™…è¿ç”¨.ä½†æ˜¯è‡ªæˆ‘æ„Ÿè§‰,æˆ‘å¯¹<code>JavaScript</code>å¼‚æ­¥ç¼–ç¨‹çš„äº†è§£ä¾ç„¶ååˆ†æµ…æ˜¾,å› æ­¤æˆ‘æ‰“ç®—å†æ¬¡å¯¹<code>JavaScript</code>ä¸­çš„å¼‚æ­¥ç¼–ç¨‹è¿›è¡Œå­¦ä¹ å’Œæ€»ç»“,ç„¶ååˆ†äº«å‡ºæ¥.</p>\n<h1>1. å‰æ–‡</h1>\n<p>åœ¨å¯¹<code>Promise</code>çŸ¥è¯†è¿›è¡Œæ€»ç»“ä¹‹å‰,æˆ‘å°†å›é¡¾ä¸€éƒ¨åˆ†<code>JavaScript</code>ä¸å¼‚æ­¥ç¼–ç¨‹ç›¸å…³çš„çŸ¥è¯†.</p>\n<h2>1.1 æµ…è¿° JavaScript è°ƒç”¨æ ˆ</h2>\n<p>å½“å‡½æ•°ä¹‹é—´å‘ç”Ÿå†…åµŒè°ƒç”¨,å°†äº§ç”Ÿ<code>å‡½æ•°è°ƒç”¨æ ˆ</code>.</p>\n<blockquote>\n<p><code>å‡½æ•°è°ƒç”¨æ ˆ</code>æ˜¯è§£é‡Šå™¨è¿½è¸ªå‡½æ•°æ‰§è¡Œæµçš„ä¸€ç§æœºåˆ¶,å‡½æ•°å…¥æ ˆçš„åŒäº‹ä¹Ÿä¿å­˜äº†å…¶ä¸Šä¸‹æ–‡ç¯å¢ƒ.</p>\n</blockquote>\n<pre><code class=\"hljs language-js\"><span class=\"lineNumber\">1</span><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">h</span>(<span class=\"hljs-params\">z</span>) </span>{\n<span class=\"lineNumber\">2</span>  <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Error</span>().stack)\n<span class=\"lineNumber\">3</span>}\n<span class=\"lineNumber\">4</span><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">g</span>(<span class=\"hljs-params\">y</span>) </span>{\n<span class=\"lineNumber\">5</span>  h(y + <span class=\"hljs-number\">1</span>)\n<span class=\"lineNumber\">6</span>}\n<span class=\"lineNumber\">7</span><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">f</span>(<span class=\"hljs-params\">x</span>) </span>{\n<span class=\"lineNumber\">8</span>  g(x + <span class=\"hljs-number\">1</span>)\n<span class=\"lineNumber\">9</span>}\n<span class=\"lineNumber\">10</span>f(<span class=\"hljs-number\">1</span>)</code></pre> \n\n<p>å¦‚ä¸Šè¿°,éšç€è°ƒç”¨å‡½æ•°<code>f(1)</code>,è°ƒç”¨æ ˆå†…å¼€å§‹å­˜å‚¨å‡½æ•°<code>f(1)</code>,å†…éƒ¨è°ƒç”¨äº†<code>g(2)</code>ä¹Ÿè¢«å­˜å…¥è°ƒç”¨æ ˆ,æœ€åå°†<code>h(3)</code>å­˜å…¥è°ƒç”¨æ ˆ,å½“å‰å‡½æ•°æ‰§è¡Œç»“æŸå³å°†ä¹‹ä»è°ƒç”¨æ ˆå®šç§»é™¤,æ¥ç€æ‰§è¡Œå¯èƒ½å­˜åœ¨çš„å‰©ä½™ä»£ç ,æœ€ç»ˆè°ƒç”¨æ ˆè¢«æ¸…ç©º,æ‰§è¡Œæµç¨‹å›åˆ°å…¨å±€ä½œç”¨åŸŸ,æœ€ç»ˆæ‰“å°å¦‚ä¸‹:</p>\n<pre><code class=\"hljs language-js\"><span class=\"lineNumber\">1</span><span class=\"hljs-built_in\">Error</span>\n<span class=\"lineNumber\">2</span>    at h (REPL3:<span class=\"hljs-number\">2</span>:<span class=\"hljs-number\">15</span>)\n<span class=\"lineNumber\">3</span>    at g (REPL6:<span class=\"hljs-number\">2</span>:<span class=\"hljs-number\">3</span>)\n<span class=\"lineNumber\">4</span>    at f (REPL9:<span class=\"hljs-number\">2</span>:<span class=\"hljs-number\">3</span>)\n<span class=\"lineNumber\">5</span>    at REPL10:<span class=\"hljs-number\">1</span>:<span class=\"hljs-number\">1</span>\n<span class=\"lineNumber\">6</span>    at Script.runInThisContext (node:vm:<span class=\"hljs-number\">133</span>:<span class=\"hljs-number\">18</span>)\n<span class=\"lineNumber\">7</span>    at REPLServer.defaultEval (node:repl:<span class=\"hljs-number\">474</span>:<span class=\"hljs-number\">29</span>)\n<span class=\"lineNumber\">8</span>    at bound (node:domain:<span class=\"hljs-number\">416</span>:<span class=\"hljs-number\">15</span>)\n<span class=\"lineNumber\">9</span>    at REPLServer.runBound [<span class=\"hljs-keyword\">as</span> <span class=\"hljs-built_in\">eval</span>] (node:domain:<span class=\"hljs-number\">427</span>:<span class=\"hljs-number\">12</span>)\n<span class=\"lineNumber\">10</span>    at REPLServer.onLine (node:repl:<span class=\"hljs-number\">793</span>:<span class=\"hljs-number\">10</span>)\n<span class=\"lineNumber\">11</span>    at REPLServer.emit (node:events:<span class=\"hljs-number\">388</span>:<span class=\"hljs-number\">22</span>)</code></pre> \n\n<p>æ ˆæ˜¯æœ‰é™åº¦çš„,ä¸åŒç¯å¢ƒçš„æ ˆç©ºé—´å¤§å°ä¸ç­‰,åˆ†é…çš„æ ˆç©ºé—´è¢«å æ»¡ä¹‹å,å°†ä¼šå¼•å‘æ ˆæº¢å‡ºé”™è¯¯.</p>\n<h2>1.2 æµ…è¿°æµè§ˆå™¨äº‹ä»¶å¾ªç¯</h2>\n<p><code>JavaScript</code>å…·æœ‰ä¸€ä¸ªåŸºäº<code>äº‹ä»¶å¾ªç¯(event loop)</code>çš„å¹¶å‘æ¨¡å‹.</p>\n<p>æˆ‘ä»¬å¯ä»¥ç®€å•çš„è®¤ä¸ºæ¯ä¸ªæµè§ˆå™¨<code>tab</code>è¿è¡Œäºä¸€ä¸ªç®€å•çš„<code>äº‹ä»¶å¾ªç¯</code>è¿›ç¨‹æ¥å®ç°<code>éé˜»å¡</code>,æµè§ˆå™¨ä¸­çš„è¯¸å¤šå•ä¸€ä»»åŠ¡,ä¾‹å¦‚:</p>\n<ul>\n<li>è§£æ HTML</li>\n<li>æ‰§è¡Œè„šæœ¬ä¸­çš„ JavaScript ä»£ç </li>\n<li>å“åº”ç”¨æˆ·äº¤äº’</li>\n<li>å¼‚æ­¥ç½‘ç»œè¯·æ±‚</li>\n<li>ç­‰ç­‰</li>\n</ul>\n<p>è¿™äº›ä»»åŠ¡å½¢æˆäº†ç‹¬ç«‹äºä¸»çº¿ç¨‹çš„<code>ä»»åŠ¡é˜Ÿåˆ—(task queue)</code>,æ‰€æœ‰ä»»åŠ¡åªèƒ½é€ä¸€é€šçŸ¥ä¸»çº¿ç¨‹è¿›è¡Œå¤„ç†.ç”±äº<code>JavaScript</code>çš„å•çº¿ç¨‹é™åˆ¶,å³ä½¿<code>Web Workeræ ‡å‡†</code>å…è®¸<code>JavaScript</code>è„šæœ¬åˆ›å»ºå¤šä¸ªçº¿ç¨‹,ä½†æ˜¯å­çº¿ç¨‹ç”±ä¸»çº¿ç¨‹æ§åˆ¶,ä¸”ä¸å¯æ“ä½œ<code>DOM</code>,å¯ä»¥è¯´<code>JavaScript</code>çš„æœ¬è´¨ä¾ç„¶æ˜¯<code>å•çº¿ç¨‹</code>.</p>\n<p>å¦‚ä¸‹æ˜¯<code>Philip Roberts</code>æ¼”è®²çš„æ—¶å€™ä½¿ç”¨çš„ç¤ºæ„å›¾:</p>\n<p><img src=\"https://www.ruanyifeng.com/blogimg/asset/2014/bg2014100802.png\" alt=\"\"></p>\n<p>å½“ä¸»çº¿ç¨‹æ‰§è¡Œæ ˆä¸Šçš„åŒæ­¥ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ä¹‹å,å°±å»è¯»å–<code>task queue</code>,æŒ‰é˜Ÿåˆ—å…ˆè¿›å…ˆå‡ºçš„å±æ€§,ä¾æ¬¡è·å–ä»»åŠ¡è¿›è¡Œå¤„ç†,ç„¶åé‡å¤æ£€æŸ¥ä¸»çº¿ç¨‹æ‰§è¡Œæ ˆ,é€šå¸¸æˆ‘ä»¬ä¸ºå¼‚æ­¥äº‹ä»¶ç¼–å†™çš„<code>å›è°ƒå‡½æ•°</code>,å°±è¿›å…¥äº†ä»»åŠ¡é˜Ÿåˆ—.</p>\n<p>å¦‚æœå†ç»†åˆ†ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡,ä¾ç„¶å¯ä»¥åˆ†ä¸º:</p>\n<ul>\n<li>å¾®ä»»åŠ¡(micro task)</li>\n<li>å®ä»»åŠ¡(macro task)</li>\n</ul>\n<p>åƒ<code>setTimeout</code>å’Œ<code>setInterval</code>åˆ™æ˜¯å®ä»»åŠ¡.</p>\n<blockquote>\n<p><strong>å½“å‰æ‰§è¡Œæ ˆæ‰§è¡Œå®Œæ¯•æ—¶ä¼šç«‹åˆ»å…ˆå¤„ç†æ‰€æœ‰å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„äº‹ä»¶ï¼Œç„¶åå†å»å®ä»»åŠ¡é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªäº‹ä»¶ã€‚åŒä¸€æ¬¡äº‹ä»¶å¾ªç¯ä¸­ï¼Œå¾®ä»»åŠ¡æ°¸è¿œåœ¨å®ä»»åŠ¡ä¹‹å‰æ‰§è¡Œ</strong>ã€‚</p>\n</blockquote>\n<h2>1.3 å®šæ—¶å™¨ç®€æ</h2>\n<p><code>setTimeout(callback, ms)</code>å‡½æ•°åˆ›å»ºäº†ä¸€ä¸ªå®šæ—¶å™¨ç­‰å¾…è‹¥å¹²æ¯«ç§’, ç„¶åå°†<code>callback</code>æ”¾å…¥<code>task queue</code>,å¹¶ä¸”åœ¨ç­‰å¾…è®¡æ—¶å™¨çš„å…¶é—´è„±ç¦»äº†ä¸»çº¿ç¨‹,è¿™ä¹Ÿå°±æ„å‘³ç€å¦‚æœä¸»çº¿ç¨‹æ‰§è¡Œäº†è€—æ—¶çš„åŒæ­¥ä»»åŠ¡,åˆ™ä»»åŠ¡é˜Ÿåˆ—è¢«è¯»å–çš„æ—¶é—´å°±å°†è¢«å»¶è¿Ÿäº†,å› æ­¤å¯èƒ½ä¸ä¼šåœ¨<code>ms</code>æ¯«ç§’åæ‰§è¡Œ<code>callback</code>å›è°ƒå‡½æ•°.</p>\n<p>å®é™…å»¶æ—¶è¿˜æœ‰å…¶ä»–çš„å½±å“å› ç´ .</p>\n<ul>\n<li>ä¸åŒæµè§ˆå™¨å…·æœ‰è‡ªå·±çš„<code>DOM_MIN_TIMEOUT_VALUE</code>,æœ€å°å»¶æ—¶å€¼.</li>\n<li>ä¸ºäº†ä¼˜åŒ–åå° tab çš„åŠ è½½æŸè€—(ä»¥åŠé™ä½è€—ç”µé‡),åœ¨æœªè¢«æ¿€æ´»çš„ tab ä¸­å®šæ—¶å™¨çš„æœ€å°å»¶æ—¶é™åˆ¶ä¸º<code>1S</code>.</li>\n<li>è¿½è¸ªå‹è„šæœ¬å»¶æ—¶åœ¨åå° tabs ä¸­,è¿™ä¸ªæœ€å°å»¶æ—¶é™åˆ¶æ˜¯ <code>10S</code>,è¿™ä¸ªé™åˆ¶ä¼šåœ¨æ–‡æ¡£ç¬¬ä¸€æ¬¡åŠ è½½åçš„<code>30s</code>åç”Ÿæ•ˆ.</li>\n</ul>\n<h2>1.4 æ˜¾ç¤º DOM å˜åŒ–</h2>\n<p>å¯¹äºå¤§å¤šæ•°<code>DOM</code>å…ƒç´ çš„å˜åŒ–æ¥è¯´,å®ƒä»¬çš„æ”¹åŠ¨æ•°æ®å¹¶ä¸æ˜¯å®æ—¶æ›´æ–°çš„,<code>DOM</code>å’Œ<code>å¸ƒå±€</code>çš„æ”¹åŠ¨ä¹Ÿä¸<code>äº‹ä»¶å¾ªç¯</code>æœºåˆ¶æœ‰å…³.å¦‚æœéœ€è¦é¢‘ç¹æ›´æ–°<code>DOM</code>,å¯ä»¥è€ƒè™‘<code>requestAnimationFrame()</code>å‡½æ•°.</p>\n<blockquote>\n<p><strong><code>window.requestAnimationFrame()</code></strong> å‘Šè¯‰æµè§ˆå™¨â€”â€”ä½ å¸Œæœ›æ‰§è¡Œä¸€ä¸ªåŠ¨ç”»ï¼Œå¹¶ä¸”è¦æ±‚æµè§ˆå™¨åœ¨ä¸‹æ¬¡é‡ç»˜ä¹‹å‰è°ƒç”¨æŒ‡å®šçš„å›è°ƒå‡½æ•°æ›´æ–°åŠ¨ç”»ã€‚è¯¥æ–¹æ³•éœ€è¦ä¼ å…¥ä¸€ä¸ªå›è°ƒå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œè¯¥å›è°ƒå‡½æ•°ä¼šåœ¨æµè§ˆå™¨ä¸‹ä¸€æ¬¡é‡ç»˜ä¹‹å‰æ‰§è¡Œ</p>\n</blockquote>\n<h2>1.5 event loop é˜»å¡å’Œæ¶ˆé™¤</h2>\n<p>æ¥çœ‹çœ‹ä¸€ä¸ªé˜»å¡äº‹ä»¶å¾ªç¯çš„ä¾‹å­ğŸŒ° From <code>Dr. Axel Rauschmayer</code>:</p>\n<pre><code class=\"hljs language-js\"><span class=\"lineNumber\">1</span>&#x3C;p>\n<span class=\"lineNumber\">2</span>  <span class=\"xml\"><span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">a</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"block\"</span> <span class=\"hljs-attr\">href</span>=<span class=\"hljs-string\">\"\"</span>></span>Block for 5 seconds<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">a</span>></span></span>\n<span class=\"lineNumber\">3</span>&#x3C;p>\n<span class=\"lineNumber\">4</span>    <span class=\"xml\"><span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">button</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"btn\"</span>></span>This is a button<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">button</span>></span></span>\n<span class=\"lineNumber\">5</span><span class=\"xml\"><span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"statusMessage\"</span>></span><span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">div</span>></span></span>\n<span class=\"lineNumber\">6</span><span class=\"xml\"><span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">script</span>></span><span class=\"javascript\">\n<span class=\"lineNumber\">7</span><span class=\"hljs-built_in\">document</span>.getElementById(<span class=\"hljs-string\">'block'</span>).addEventListener(<span class=\"hljs-string\">'click'</span>, onClick);\n<span class=\"lineNumber\">8</span><span class=\"hljs-built_in\">document</span>.getElementById(<span class=\"hljs-string\">'btn'</span>).addEventListener(<span class=\"hljs-string\">'click'</span>, onClickBtn);\n<span class=\"lineNumber\">9</span> \n<span class=\"lineNumber\">10</span><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">onClickBtn</span>(<span class=\"hljs-params\"></span>) </span>{\n<span class=\"lineNumber\">11</span>  <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">\"click the btn\"</span>)\n<span class=\"lineNumber\">12</span>}\n<span class=\"lineNumber\">13</span> \n<span class=\"lineNumber\">14</span><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">onClick</span>(<span class=\"hljs-params\">event</span>) </span>{\n<span class=\"lineNumber\">15</span>  event.preventDefault();\n<span class=\"lineNumber\">16</span> \n<span class=\"lineNumber\">17</span>  setStatusMessage(<span class=\"hljs-string\">'Blocking...'</span>);\n<span class=\"lineNumber\">18</span> \n<span class=\"lineNumber\">19</span>  <span class=\"hljs-comment\">// Call setTimeout(), so that browser has time to display</span>\n<span class=\"lineNumber\">20</span>  <span class=\"hljs-comment\">// status message</span>\n<span class=\"lineNumber\">21</span>  <span class=\"hljs-built_in\">setTimeout</span>(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>{\n<span class=\"lineNumber\">22</span>    sleep(<span class=\"hljs-number\">5000</span>);\n<span class=\"lineNumber\">23</span>    setStatusMessage(<span class=\"hljs-string\">'Done'</span>);\n<span class=\"lineNumber\">24</span>  }, <span class=\"hljs-number\">0</span>);\n<span class=\"lineNumber\">25</span>}\n<span class=\"lineNumber\">26</span><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">setStatusMessage</span>(<span class=\"hljs-params\">msg</span>) </span>{\n<span class=\"lineNumber\">27</span>  <span class=\"hljs-built_in\">document</span>.getElementById(<span class=\"hljs-string\">'statusMessage'</span>).textContent = msg;\n<span class=\"lineNumber\">28</span>}\n<span class=\"lineNumber\">29</span><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">sleep</span>(<span class=\"hljs-params\">milliseconds</span>) </span>{\n<span class=\"lineNumber\">30</span>  <span class=\"hljs-keyword\">var</span> start = <span class=\"hljs-built_in\">Date</span>.now();\n<span class=\"lineNumber\">31</span>  <span class=\"hljs-keyword\">while</span> ((<span class=\"hljs-built_in\">Date</span>.now() - start) &#x3C; milliseconds);\n<span class=\"lineNumber\">32</span>}\n<span class=\"lineNumber\">33</span></span><span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">script</span>></span></span></code></pre> \n\n<p>æˆ‘ç»™<code>button</code>åŠ äº†ç‚¹å‡»ç›‘å¬,å¦‚ä¸Šæ‰€ç¤º,å½“ä½ ç‚¹å‡»é“¾æ¥è§¦å‘ç›‘å¬å‡½æ•°çš„æ—¶å€™å†ç‚¹å‡»<code>button</code>,äº‹ä»¶å¾ªç¯è¢«é˜»å¡5ç§’.è¿™ä¸ªæœŸé—´ç‚¹å‡»<code>button</code>çš„ç›‘å¬å‡½æ•°æ— æ³•å¦‚<code>\"é¢„æœŸ\"</code>é©¬ä¸Šæ‰§è¡Œå…¶é€»è¾‘,é˜»å¡çŠ¶æ€ç»“æŸä¹‹å,ç‚¹å‡»å‡½æ•°çš„ç›‘å¬æ•ˆæœæ‰ä¼šå‡ºç°.</p>\n<p>æˆ‘ä»¬æœ‰ä¸¤ç§æ–¹æ³•æ¶ˆé™¤äº‹ä»¶å¾ªç¯çš„é˜»å¡,å…¶ä¸€ä¾¿æ˜¯å°†è€—æ—¶çš„ä»»åŠ¡è½¬ç§»åˆ°<code>Worker API</code>ä¸­å»,è®©å¦ä¸€ä¸ªçº¿ç¨‹å»å¤„ç†.å…¶äºŒä¾¿æ˜¯ä¸ä½¿ç”¨åŒæ­¥çš„é•¿æ—¶é—´ç­‰å¾…é€»è¾‘,è€Œæ˜¯é€‰æ‹©ä½¿ç”¨å¼‚æ­¥çš„æ–¹å¼å»æ”¹å†™è€—æ—¶çš„åŒæ­¥ä»£ç .ä¾‹å¦‚ä¸Šè¿°çš„<code>sleep</code>å‡½æ•°ä¾¿å¯ä»¥ä½¿ç”¨<code>setTimeout</code>æ¥è®©æˆ‘ä»¬è¾¾åˆ°å¼‚æ­¥çš„æ•ˆæœ.</p>\n<h2>1.6 å¼‚æ­¥æ¥æ”¶ç»“æœ</h2>\n<p>é¦–å…ˆ,è®©æˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•é€šè¿‡<code>äº‹ä»¶å¤„ç†æœºåˆ¶</code>æ¥å¼‚æ­¥è·å–ç»“æœ,æ¥çœ‹çœ‹ä¸€ä¸ª<code>XMLHttpRequest</code>çš„ä¾‹å­:</p>\n<pre><code class=\"hljs language-js\"><span class=\"lineNumber\">1</span><span class=\"hljs-keyword\">const</span> req = <span class=\"hljs-keyword\">new</span> XMLHttpRequest();\n<span class=\"lineNumber\">2</span>req.open(<span class=\"hljs-string\">'GET'</span>, url);\n<span class=\"lineNumber\">3</span><span class=\"hljs-comment\">// req.send();</span>\n<span class=\"lineNumber\">4</span>req.onload = <span class=\"hljs-function\">() =></span> {\n<span class=\"lineNumber\">5</span>  <span class=\"hljs-function\"><span class=\"hljs-title\">if</span>(<span class=\"hljs-params\">req.status === <span class=\"hljs-number\">200</span></span>)</span> {\n<span class=\"lineNumber\">6</span>    <span class=\"hljs-comment\">// balabala</span>\n<span class=\"lineNumber\">7</span>  } <span class=\"hljs-keyword\">else</span> {\n<span class=\"lineNumber\">8</span>  \t<span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">`Error: <span class=\"hljs-subst\">${req.statusText}</span>`</span>) \n<span class=\"lineNumber\">9</span>  } \n<span class=\"lineNumber\">10</span>}\n<span class=\"lineNumber\">11</span> \n<span class=\"lineNumber\">12</span>req.onerror = <span class=\"hljs-function\">() =></span> {\n<span class=\"lineNumber\">13</span>  <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'Error...'</span>)\n<span class=\"lineNumber\">14</span>}\n<span class=\"lineNumber\">15</span> \n<span class=\"lineNumber\">16</span>req.send();</code></pre> \n\n<p><code>req.send()</code>æ‰§è¡Œçš„æ—¶å€™åªæ˜¯å°†ä¹‹æ·»åŠ åˆ°<code>ä»»åŠ¡é˜Ÿåˆ—</code>ä¸­,è€Œéç«‹åˆ»æ‰§è¡Œæ­¤è¯·æ±‚.å› æ­¤,æˆ‘ä»¬ä¹Ÿå¯ä»¥å°†ä¹‹å†™åœ¨è®¾ç½®<code>onload</code>å’Œ<code>onerror</code>äº‹ä»¶çš„ä»£ç ä¹‹å‰.</p>\n<p>ç±»ä¼¼<code>Vue</code>å’Œ<code>Angular</code>ä¸­æˆ‘ä»¬æœ‰æ—¶å€™ä¼šçœ‹åˆ°å¦‚ä¸‹ä»£ç :</p>\n<pre><code class=\"hljs language-js\"><span class=\"lineNumber\">1</span><span class=\"hljs-comment\">// Vue</span>\n<span class=\"lineNumber\">2</span>&#x3C;button v-on:click=<span class=\"hljs-string\">\"fb\"</span>>\n<span class=\"lineNumber\">3</span>  Add <span class=\"hljs-number\">1</span>\n<span class=\"lineNumber\">4</span>&#x3C;/button>\n<span class=\"lineNumber\">5</span><span class=\"hljs-comment\">// Angular</span>\n<span class=\"lineNumber\">6</span><span class=\"xml\"><span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">button</span> (<span class=\"hljs-attr\">click</span>)=<span class=\"hljs-string\">\"fb()\"</span>></span>\n<span class=\"lineNumber\">7</span>  some thing\n<span class=\"lineNumber\">8</span><span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">button</span>></span></span></code></pre> \n\n<p>ä¸Šè¿°ä»£ç <code>å¹¶ä¸æ˜¯è¡Œå†…å±æ€§</code>,æˆ‘ä»¬å¯ä»¥å¾ˆçµæ´»çš„åˆ©ç”¨<code>JavaScript</code>å’Œæ¡†æ¶çš„ç‰¹æ€§çµæ´»ç¼–å†™ä»£ç ,ä¸º<code>DOM</code>æ·»åŠ äº‹ä»¶ç›‘å¬.</p>\n<blockquote>\n<p>ä¸Šè¿°ç¤ºä¾‹ä»£ç é£æ ¼åªèƒ½ç»™ç›¸åº”çš„å±æ€§è®¾ç½®ä¸€ä¸ªå€¼,åç»­çš„<code>onload</code>å€¼å°†ä¼šè¦†ç›–å‰è€….</p>\n</blockquote>\n<p>åœ¨<code>IE9</code>ä¹‹å,æ›´å¸¸è§çš„äº‹ä»¶å¤„ç†æœºåˆ¶çš„ä½¿ç”¨æ–¹æ¡ˆä¹Ÿè®¸æ˜¯<code>addEventListener</code>(IE8 åˆ™å¯ä»¥ä½¿ç”¨<code>attachEvent</code>è¿›è¡Œ hack),è¿™ç§æ–¹æ¡ˆèƒ½å¤Ÿæ›´å¤§é™åº¦çš„è®¾ç½®äº‹ä»¶ç›‘å¬çš„èŒƒå›´,ä¾‹å¦‚è®¾ç½®å¤šä¸ªåŒç±»å‹çš„äº‹ä»¶å¤„ç†å‡½æ•°,åˆ é™¤æŸä¸ªç›‘å¬å‡½æ•°ç­‰ç­‰.</p>\n<p>æ¥ç€,æˆ‘ä»¬æ¥çœ‹çœ‹é€šè¿‡<code>callback</code>å›è°ƒå‡½æ•°è·å–å¼‚æ­¥ç»“æœçš„ç¤ºä¾‹:</p>\n<pre><code class=\"hljs language-js\"><span class=\"lineNumber\">1</span><span class=\"hljs-comment\">// Node.js</span>\n<span class=\"lineNumber\">2</span>fs.readFile(<span class=\"hljs-string\">'file.txt'</span>, { <span class=\"hljs-attr\">encoding</span>: <span class=\"hljs-string\">'utf8'</span>}, <span class=\"hljs-function\">(<span class=\"hljs-params\">error, text</span>) =></span> {\n<span class=\"lineNumber\">3</span>  <span class=\"hljs-function\"><span class=\"hljs-title\">if</span>(<span class=\"hljs-params\">error</span>)</span> {\n<span class=\"lineNumber\">4</span>    <span class=\"hljs-comment\">// balabala</span>\n<span class=\"lineNumber\">5</span>  }\n<span class=\"lineNumber\">6</span>  <span class=\"hljs-comment\">// æ— é”™è¯¯</span>\n<span class=\"lineNumber\">7</span>  <span class=\"hljs-comment\">// balabala</span>\n<span class=\"lineNumber\">8</span>})</code></pre> \n\n<p>å¦‚ä¸Šæ‰€ç¤º,å¦‚æœè¯»å–æ–‡ä»¶å†…å®¹é¡ºåˆ©,å°†ä¼šæ‰§è¡Œå›è°ƒå‡½æ•°.å›è°ƒå‡½æ•°çº¦å®šæ¥æ”¶ä¸¤ä¸ªå‚æ•°,ä¸€ä¸ªæ˜¯<code>é”™è¯¯</code>å¯¹è±¡,å¦ä¸€ä¸ªä¾¿æ˜¯<code>é¢„æœŸæ•°æ®</code>,å¦‚æœæˆ‘ä»¬ä¸æŒ‰çº¦å®šç¼–å†™å›è°ƒå‡½æ•°,ä¹Ÿä¸ä¼šæŠ¥é”™.</p>\n<p>å¦‚ä¸Šè¿™ç§å¼‚æ­¥ç¼–ç¨‹é£æ ¼è¢«ç§°ä¸º<code>continuation-passing style(CPS)</code>,å¼€å‘è€…æ€»æ˜¯ä½¿ç”¨ä¸€ä¸ªå›è°ƒå‡½æ•°ä½œä¸ºå‚æ•°å»è°ƒç”¨,æ˜¾ç¤ºçš„å°†<code>æ§åˆ¶æµ</code>ä½œä¸ºå‚æ•°è¿›è¡Œä¼ é€’,å¼€å‘è€…å¯ä»¥çœ‹åˆ°ç¨‹åºå†…éƒ¨éšå¼çš„æ§åˆ¶æµè·³è½¬.</p>\n<p><code>CPS</code>æŒºæœ‰è¶£çš„,æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªç®€å•ä¾‹å­.</p>\n<pre><code class=\"hljs language-js\"><span class=\"lineNumber\">1</span><span class=\"hljs-comment\">// çœç•¥éƒ¨åˆ†ä»£ç </span>\n<span class=\"lineNumber\">2</span><span class=\"hljs-keyword\">const</span> a = foo(x)\n<span class=\"lineNumber\">3</span><span class=\"hljs-keyword\">const</span> b = someFunction(a)</code></pre> \n\n<p>å¦‚æœæˆ‘ä»¬æŒ‰<code>CPS</code>é£æ ¼æ¥å†™:</p>\n<pre><code class=\"hljs language-js\"><span class=\"lineNumber\">1</span><span class=\"hljs-keyword\">const</span> b = foo(x, someFunction)</code></pre> \n\n<p>ç”±æ­¤å¯è§,æˆ‘ä»¬å¯ä»¥åœ¨ä¾‹å¦‚<code>æƒ°æ€§æ±‚å€¼/å¼‚æ­¥/æµç¨‹æ§åˆ¶</code>ç­‰åœºæ™¯ä¸‹ç¼–å†™ä¸Šè¿°é£æ ¼çš„ä»£ç ,<code>\"ä¹Ÿè®¸\"</code>æ˜¯ä¸€ç§æ›´å¥½çš„é€‰æ‹©(ä»è€…è§ä»æ™ºè€…è§æ™º).</p>\n<p>æ¥çœ‹å¦ä¸€ä¸ªä¾‹å­:</p>\n<pre><code class=\"hljs language-js\"><span class=\"lineNumber\">1</span><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">foo</span>(<span class=\"hljs-params\">input, callback</span>) </span>{\n<span class=\"lineNumber\">2</span>\t<span class=\"hljs-built_in\">setTimeout</span>(<span class=\"hljs-function\">() =></span> {\n<span class=\"lineNumber\">3</span>    callback(input)\n<span class=\"lineNumber\">4</span>  }, <span class=\"hljs-number\">0</span>)\n<span class=\"lineNumber\">5</span>}\n<span class=\"lineNumber\">6</span><span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'a'</span>)\n<span class=\"lineNumber\">7</span>foo(<span class=\"hljs-string\">'b'</span>, <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">step2</span>(<span class=\"hljs-params\">param</span>) </span>{\n<span class=\"lineNumber\">8</span>\t<span class=\"hljs-built_in\">console</span>.log(param)\n<span class=\"lineNumber\">9</span>  foo(<span class=\"hljs-string\">'c'</span>, <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">step3</span>(<span class=\"hljs-params\">param</span>) </span>{\n<span class=\"lineNumber\">10</span>  \t<span class=\"hljs-built_in\">console</span>.log(param)\n<span class=\"lineNumber\">11</span>  })\n<span class=\"lineNumber\">12</span> \t<span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'d'</span>)\n<span class=\"lineNumber\">13</span>})\n<span class=\"lineNumber\">14</span><span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'e'</span>)</code></pre> \n\n<p>è¾“å‡ºç»“æœ:<code> a e b d c</code>.</p>\n<p>å›è°ƒå’Œæ§åˆ¶æµç›¸äº’åµŒå¥—,å¸¸å¸¸è®©æˆ‘ä»¬å†™å‡º<code>\"å›è°ƒåœ°ç‹±\"</code>ä»£ç .</p>\n<p>åœ¨<code>Promise</code>å‡ºç°ä¹‹å‰,å¼€å‘è€…ä»¬ç¼–å†™ç€å„ç§å›è°ƒå‡½æ•°,ä¸ºäº†é¿å…éšå¼<code>BUG</code>è€Œå­œå­œä¸å€¦åœ°æ£€æŸ¥å¼‚å¸¸å¤„ç†é€»è¾‘,é‡å¤åœ°ä¸ºæ¯ä¸€ä¸ªå›è°ƒå‡½æ•°ç¼–å†™å†—é•¿çš„<code>if error</code>é”™è¯¯ç›‘å¬.</p>\n<h1>2. Promise å¼‚æ­¥</h1>\n<p><code>TC39</code>ä¾æ®<code>Promise/A+</code>åˆ¶å®šäº†<code>ES6 Promise</code>è§„èŒƒ,è‡ªæ­¤<code>JavaScript</code>å¼‚æ­¥ç¼–ç¨‹å‘å‰è¿ˆè¿›äº†ä¸€å¤§æ­¥,å¼€å‘è€…ä»¬å¯ä»¥æ›´å¥½çš„ç¼–å†™å¼‚æ­¥ä»£ç ä»¥åº”å¯¹å¤æ‚çš„åœºæ™¯å’Œéœ€æ±‚.</p>\n<blockquote>\n<p>IE æµè§ˆå™¨ä¸æ”¯æŒ<code>Promise</code>,æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>es-promise</code>ç­‰ç¬¬ä¸‰æ–¹åº“.</p>\n</blockquote>\n<h2>2.1 promise å®ä¾‹å’ŒçŠ¶æ€è½¬æ¢</h2>\n<p><code>Promise</code>å®ä¾‹å…·æœ‰ä¸‰ç§çŠ¶æ€:</p>\n<ul>\n<li><code>pending</code>: åˆå§‹åŒ–</li>\n<li><code>fulfilled</code>: æˆåŠŸ</li>\n<li><code>rejected</code>: å¤±è´¥</li>\n</ul>\n<blockquote>\n<p>fulfilled å’Œ rejected ç»Ÿç§°<code>settled</code>.</p>\n</blockquote>\n<p>é€šè¿‡<code>Promise</code>æ„é€ å™¨å®ä¾‹åŒ–ä¸€ä¸ª<code>promise</code>çš„æ—¶å€™,å…¶çŠ¶æ€ä¸º<code>pending</code>.åœ¨å®ä¾‹åŒ–çš„æ—¶å€™ä¼ å…¥ä¸€ä¸ªå‡½æ•°<code>(execotor)</code>å»å¤„ç†çŠ¶æ€è½¬æ¢é€»è¾‘.</p>\n<blockquote>\n<p>æœ¬æ–‡ä¸ä¼šå¯¹<code>promise</code>åšé¢é¢ä¿±åˆ°çš„ä»‹ç»,æ¨èé˜…è¯»å®˜æ–¹æ–‡æ¡£.</p>\n</blockquote>\n<p>é¦–å…ˆ,æˆ‘ä»¬æ¥åˆ›å»ºä¸€ä¸ª<code>promise</code>å®ä¾‹:</p>\n<pre><code class=\"hljs language-js\"><span class=\"lineNumber\">1</span><span class=\"hljs-keyword\">let</span> promise = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">resolve, reject</span>) =></span> {\n<span class=\"lineNumber\">2</span>  <span class=\"hljs-comment\">// balabala</span>\n<span class=\"lineNumber\">3</span>  <span class=\"hljs-function\"><span class=\"hljs-title\">if</span>(<span class=\"hljs-params\">...</span>)</span> {\n<span class=\"lineNumber\">4</span>    resolve(value) <span class=\"hljs-comment\">// success</span>\n<span class=\"lineNumber\">5</span>  } <span class=\"hljs-keyword\">else</span> {\n<span class=\"lineNumber\">6</span>  \treject(reason) <span class=\"hljs-comment\">// failure</span>\n<span class=\"lineNumber\">7</span>  }\n<span class=\"lineNumber\">8</span>})\n<span class=\"lineNumber\">9</span>promise\n<span class=\"lineNumber\">10</span>  .then(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">value</span>) </span>{\n<span class=\"lineNumber\">11</span>\t\t<span class=\"hljs-comment\">// balabala</span>\n<span class=\"lineNumber\">12</span>  })\n<span class=\"lineNumber\">13</span>\t.then(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">value</span>) </span>{\n<span class=\"lineNumber\">14</span>\t\t<span class=\"hljs-comment\">// balabala</span>\n<span class=\"lineNumber\">15</span>  })\n<span class=\"lineNumber\">16</span>\t.catch(<span class=\"hljs-function\"><span class=\"hljs-params\">reason</span> =></span> {\n<span class=\"lineNumber\">17</span>  \t<span class=\"hljs-comment\">// balabala</span>\n<span class=\"lineNumber\">18</span>  })</code></pre> \n\n<p>ä¼ å…¥çš„å‡½æ•°å†…éƒ¨,å¯ä»¥æ˜¾ç¤ºæŒ‰é€»è¾‘æŒ‡å®šä¸‹ä¸€ä¸ªçŠ¶æ€.ä¸‹å›¾æ˜¯<code>MDN</code>æä¾›çš„<code>Promise</code>çŠ¶æ€è½¬ç§»å›¾.</p>\n<p><img src=\"https://mdn.mozillademos.org/files/8633/promises.png\" alt=\"\"></p>\n<blockquote>\n<p><code>then</code>å‡½æ•°å¯ä»¥æ¥æ”¶ä¸åŒå½¢å‚çš„å‡½æ•°ä»¥å®ç°ä¸åŒçš„çŠ¶æ€å¤„ç†é€»è¾‘,ä½†æ˜¯æˆ‘ä»¬æ¨èä½¿ç”¨å•å‚æ•°å’Œä½¿ç”¨ catch å¤„ç†é”™è¯¯çš„ä»£ç é£æ ¼.</p>\n</blockquote>\n<p>éœ€è¦æ³¨æ„çš„æ˜¯,<code>promise</code>å®ä¾‹çš„çŠ¶æ€è½¬æ¢æ˜¯å•å‘çš„,ä¸€æ—¦<code>settled</code>åˆ™ä¸å¯é€†è½¬.</p>\n<p><code>promise</code>æ”¯æŒé“¾å¼è°ƒç”¨,æ¯ä¸ª<code>then</code>å‡½æ•°å†…éƒ¨æœ€åå°†è¿”å›ä¸€ä¸ªæ–°çš„<code>promise</code>å®ä¾‹,é»˜è®¤è¿”å›ä¸€ä¸ªå€¼ä¸º<code>undefined</code>,çŠ¶æ€ä¸º<code>fulfilled</code>çš„<code>promise</code>å®ä¾‹.</p>\n<p><strong><code>Promise</code>å‡ºç°ä¹‹å‰,ç¼–å†™å¯ä»¥ä¸€æ¬¡æ€§ç›‘å¬æ‰€æœ‰å›è°ƒå‡½æ•°çš„é”™è¯¯å¤„ç†é€»è¾‘æ˜¯å›°éš¾çš„,<code>Promiseå®ä¾‹</code>çš„å®ä¾‹æ–¹æ³•<code>catch</code>èƒ½åº”å¯¹é“¾å¼è°ƒç”¨ä¹‹å‰æ‰€æœ‰çš„<code>then</code>å‡½æ•°é”™è¯¯å’Œæ˜¾ç¤ºçš„<code>reject</code>è¡Œä¸º</strong>.</p>\n<p>æˆ‘ä»¬å¯ä»¥æ˜¾ç¤ºåœ°ä½¿ç”¨<code>return value</code>æŒ‡å®šè¿”å›çš„<code>promise</code>å¯¹è±¡çš„å€¼.ä¸¾ä¸ªä¾‹å­:</p>\n<pre><code class=\"hljs language-js\"><span class=\"lineNumber\">1</span>asyncFunc()\n<span class=\"lineNumber\">2</span>\t.then(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">v1</span>) </span>{\n<span class=\"lineNumber\">3</span>  \t<span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">1</span>\n<span class=\"lineNumber\">4</span>  \t<span class=\"hljs-comment\">// return Promise.resolve(1)  \t</span>\n<span class=\"lineNumber\">5</span>})\n<span class=\"lineNumber\">6</span>\t.then(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">v2</span>) </span>{\n<span class=\"lineNumber\">7</span>  \t<span class=\"hljs-built_in\">console</span>.log(v2); <span class=\"hljs-comment\">// 1</span>\n<span class=\"lineNumber\">8</span>})</code></pre> \n\n<p>é™¤äº†<code>return</code>ä¸€ä¸ªæ˜¾ç¤ºçš„å€¼,åœ¨ä¸€äº›<code>Promise</code>ç›¸å…³çš„åº“æºç ä¸­æˆ‘ä»¬å¯èƒ½è¿˜ä¼šçœ‹åˆ°æŸäº›åœºæ™¯ä¸‹è¿”å›ä¸€ä¸ª<code>thenable</code>å¯¹è±¡.</p>\n<blockquote>\n<p><code>thenableå¯¹è±¡</code>: ä»»æ„å…·æœ‰<code>then</code>æ–¹æ³•çš„å¯¹è±¡.</p>\n</blockquote>\n<p>è¿”å›<code>thenableå¯¹è±¡</code>çš„æ—¶å€™å°†æ‰§è¡Œå…¶<code>then</code>æ–¹æ³•,<code>Promise</code>å®ä¾‹å¯¹è±¡ä¹Ÿæ˜¯<code>thenableå¯¹è±¡</code>,å› æ­¤åœ¨æŸäº›åµŒå¥—<code>Promise</code>çš„åœºæ™¯ä¸‹,å¯ä»¥è¿”å›ä¸€ä¸ª<code>å¼‚æ­¥å‡½æ•°è°ƒç”¨</code>,å°±åƒè¿™æ ·:</p>\n<pre><code class=\"hljs language-js\"><span class=\"lineNumber\">1</span>asyncFunc1()\n<span class=\"lineNumber\">2</span>\t.then(<span class=\"hljs-function\"><span class=\"hljs-params\">v1</span> =></span> {\n<span class=\"lineNumber\">3</span>  \tasyncFunc2()\n<span class=\"lineNumber\">4</span>  \t\t.then(<span class=\"hljs-function\"><span class=\"hljs-params\">v2</span> =></span> {\n<span class=\"lineNumber\">5</span>      \t<span class=\"hljs-comment\">//balabala</span>\n<span class=\"lineNumber\">6</span>    })\n<span class=\"lineNumber\">7</span>})\n<span class=\"lineNumber\">8</span> \n<span class=\"lineNumber\">9</span><span class=\"hljs-comment\">// æ‰å¹³åŒ–</span>\n<span class=\"lineNumber\">10</span>asyncFunc1()\n<span class=\"lineNumber\">11</span>\t.then(<span class=\"hljs-function\"><span class=\"hljs-params\">v1</span> =></span> asyncFunc2())\n<span class=\"lineNumber\">12</span>\t.then(<span class=\"hljs-function\"><span class=\"hljs-params\">v2</span> =></span> {\n<span class=\"lineNumber\">13</span>  \t<span class=\"hljs-comment\">// balabala</span>\n<span class=\"lineNumber\">14</span>})</code></pre> \n\n<h2>2.2 Promise é™æ€æ–¹æ³•</h2>\n<p><code>Promise</code>ç±»å…·æœ‰ä¸¤ä¸ªèƒ½åˆ›å»ºä¸€ä¸ªæ–°çš„å®ä¾‹çš„é™æ€æ–¹æ³•:</p>\n<ul>\n<li>Promise.resolve(param)</li>\n<li>Promise.reject(param)</li>\n</ul>\n<p>äºŒè€…åŒºåˆ«åœ¨äºè¿”å›çš„<code>promise</code>å®ä¾‹çš„çŠ¶æ€,å‰è€…ä¸º<code>fulfilled</code>,åè€…ä¸º<code>rejected</code>.</p>\n<p>æ­¤å¤–,<code>Promise</code>ç±»è¿˜æœ‰å¦‚ä¸‹å‡ ä¸ªé™æ€æ–¹æ³•:</p>\n<ul>\n<li><code>Promise.all(iterable)</code></li>\n<li><code>Promise.race(iterable)</code></li>\n<li><code>Promise.any(iterable)</code></li>\n<li><code>Promise.allSettled(iterable)</code></li>\n</ul>\n<p>è¿™å‡ ä¸ªé™æ€æ–¹æ³•å„æœ‰å…¶åº”ç”¨åœºæ™¯.</p>\n<h3>2.2.1 all</h3>\n<p>é¦–å…ˆ,<code>Promise.all(iterable)</code>æ–¹æ³•æ¥æ”¶ä¸€ä¸ª<code>iterable</code>å¯¹è±¡ä½œä¸ºå‚æ•°,æœ€ç»ˆè¿”å›ä¸€ä¸ª<code>promise å®ä¾‹</code>.</p>\n<p>é¦–å…ˆ,å¦‚æœ<code>iterable</code>å¯¹è±¡æ˜¯ç©ºçš„,åˆ™è¿”å›çš„ç»“æœæ˜¯ç©ºæ•°ç»„(å°½ç®¡æˆ‘ä»¬åŸºæœ¬ä¸Šä¸ä¼šè¿™ä¹ˆåš).</p>\n<p>å…¶æ¬¡,å¦‚æœä¼ å…¥çš„æ˜¯åŸå§‹æ•°æ®ç±»å‹åˆ™è½¬æ¢ä¸º<code>fulfilled</code>çŠ¶æ€çš„<code>promise</code>å®ä¾‹,å…¶å€¼æ˜¯åŸå§‹å¯¹è±¡.å¦‚æœä¼ å…¥çš„æœ¬æ¥å°±æ˜¯<code>promise</code>å¯¹è±¡,åˆ™ç›´æ¥æŒ‰<code>promise</code>å¯¹è±¡å¤„ç†.</p>\n<p>æˆ‘ä»¬é€šè¿‡ç¤ºä¾‹ä»£ç æ¥ç†è§£è§„èŒƒ:</p>\n<pre><code class=\"hljs language-js\"><span class=\"lineNumber\">1</span>> <span class=\"hljs-built_in\">Promise</span>.all([<span class=\"hljs-number\">1</span>, <span class=\"hljs-built_in\">Promise</span>.resolve(<span class=\"hljs-number\">2</span>)]).then(<span class=\"hljs-function\"><span class=\"hljs-params\">r</span> =></span> <span class=\"hljs-built_in\">console</span>.log(r))\n<span class=\"lineNumber\">2</span><span class=\"hljs-built_in\">Promise</span> { &#x3C;pending> }\n<span class=\"lineNumber\">3</span>> [ <span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">2</span> ]\n<span class=\"lineNumber\">4</span>> <span class=\"hljs-built_in\">Promise</span>.all([<span class=\"hljs-number\">1</span>, <span class=\"hljs-built_in\">Promise</span>.resolve(<span class=\"hljs-number\">2</span>), <span class=\"hljs-built_in\">Promise</span>.reject(<span class=\"hljs-number\">3</span>)])\n<span class=\"lineNumber\">5</span>  \t.then(<span class=\"hljs-function\"><span class=\"hljs-params\">r</span> =></span> <span class=\"hljs-built_in\">console</span>.log(r))\n<span class=\"lineNumber\">6</span>  \t.catch(<span class=\"hljs-function\"><span class=\"hljs-params\">r</span> =></span> <span class=\"hljs-built_in\">console</span>.log(r))\n<span class=\"lineNumber\">7</span><span class=\"hljs-built_in\">Promise</span> { &#x3C;pending> }\n<span class=\"lineNumber\">8</span>> <span class=\"hljs-number\">3</span></code></pre> \n\n<p>ç”±ä¸Šå¯çŸ¥,å½“å¯è¿­ä»£å¯¹è±¡çš„æ‰€æœ‰å…ƒç´ éƒ½æ˜¯<code>fulfilled</code>çŠ¶æ€çš„<code>promise å®ä¾‹</code>çš„è¯,è¿”å›ä¸€ä¸ªæ•°ç»„,æ•°ç»„çš„å€¼æ˜¯è¿™äº›<code>promise å®ä¾‹çš„å€¼</code>.</p>\n<p>å¦‚æœä¸€æ—¦å…¶ä¸­ä¹‹ä¸€å‡ºç°<code>rejected</code>çŠ¶æ€çš„<code>promise å®ä¾‹</code>,åˆ™æ•´ä½“çŠ¶æ€è½¬åŒ–ä¸º<code>rejected</code>,ä¸”å€¼ä¸ºæœ€å…ˆå‡ºç°çš„<code>rejected</code>çŠ¶æ€å®ä¾‹çš„å€¼.</p>\n<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>Promise.all</code>æ¥æ‰§è¡Œä¸€ç»„å¼‚æ­¥æ“ä½œ,è¿™äº›æ“ä½œçš„æ—¶é—´èŠ±è´¹å–å†³äºæœ€é•¿çš„é‚£ä¸ªå…ƒç´ ,å¹¶ä¸”æœ€ç»ˆå¦‚æœä¸€åˆ‡é¡ºåˆ©,åˆ™ç»“æœçš„é¡ºåºæ˜¯ä¸å˜çš„.</p>\n<p><code>Promise.all()</code>æ–¹æ³•é€‚ç”¨äº<code>åˆå¹¶è¯·æ±‚</code>çš„åœºæ™¯,ä¾‹å¦‚æŸäº›é¡¹ç›®ä¸­,æäº¤çš„å¤šä¸ªæ•°æ®éœ€è¦è°ƒç”¨äº‘ç«¯æ¥å£è¿›è¡Œæ•°æ®æ ¡éªŒ,å½“æ‰€æœ‰æ•°æ®éƒ½é€šè¿‡æ ¡éªŒçš„æ—¶å€™æ‰èƒ½æ‰§è¡Œä¸‹ä¸€æ­¥æ“ä½œ,æ¥çœ‹çœ‹ä»£ç :</p>\n<pre><code class=\"hljs language-js\"><span class=\"lineNumber\">1</span><span class=\"hljs-comment\">// æœ‰ä¸€ä¸ªè¿”å› promise å¯¹è±¡çš„ asyncApi å‡½æ•°</span>\n<span class=\"lineNumber\">2</span><span class=\"hljs-keyword\">const</span> test = <span class=\"hljs-function\">(<span class=\"hljs-params\">value</span>) =></span> asyncApi(value)\n<span class=\"lineNumber\">3</span><span class=\"hljs-built_in\">Promise</span>.all([\n<span class=\"lineNumber\">4</span>  test(<span class=\"hljs-string\">'xxx'</span>),\n<span class=\"lineNumber\">5</span>  test(<span class=\"hljs-string\">'xx'</span>),\n<span class=\"lineNumber\">6</span>  test(<span class=\"hljs-string\">'x'</span>)\n<span class=\"lineNumber\">7</span>]).then(<span class=\"hljs-function\"><span class=\"hljs-params\">results</span> =></span> {\n<span class=\"lineNumber\">8</span>  results.forEach(<span class=\"hljs-function\"><span class=\"hljs-params\">result</span> =></span> {\n<span class=\"lineNumber\">9</span>    <span class=\"hljs-comment\">// balabala ä½ çš„ä»£ç é€»è¾‘</span>\n<span class=\"lineNumber\">10</span>    <span class=\"hljs-comment\">// éƒ½é€šè¿‡äº†</span>\n<span class=\"lineNumber\">11</span>  })\n<span class=\"lineNumber\">12</span>  <span class=\"hljs-comment\">// do more...</span>\n<span class=\"lineNumber\">13</span>}).catch(<span class=\"hljs-function\"><span class=\"hljs-params\">error</span> =></span> {\n<span class=\"lineNumber\">14</span>  <span class=\"hljs-comment\">// å¤±è´¥çš„å€¼, balabala</span>\n<span class=\"lineNumber\">15</span>  <span class=\"hljs-built_in\">console</span>.log(error)\n<span class=\"lineNumber\">16</span>})</code></pre> \n\n<p>å¦‚æœæˆ‘ä»¬æƒ³è¦åˆå¹¶æ£€æŸ¥ç»“æœ,åˆ™å¯ä»¥ç¨å¾®ä¿®æ”¹ä¸€ä¸‹ä»£ç :</p>\n<pre><code class=\"hljs language-js\"><span class=\"lineNumber\">1</span><span class=\"hljs-built_in\">Promise</span>.all([\n<span class=\"lineNumber\">2</span>  test(<span class=\"hljs-string\">'xxx'</span>).catch(<span class=\"hljs-function\"><span class=\"hljs-params\">err</span> =></span> err),\n<span class=\"lineNumber\">3</span>  test(<span class=\"hljs-string\">'xx'</span>).catch(<span class=\"hljs-function\"><span class=\"hljs-params\">err</span> =></span> err),\n<span class=\"lineNumber\">4</span>  test(<span class=\"hljs-string\">'x'</span>).catch(<span class=\"hljs-function\"><span class=\"hljs-params\">err</span> =></span> err)\n<span class=\"lineNumber\">5</span>]).then(<span class=\"hljs-function\"><span class=\"hljs-params\">results</span> =></span> {\n<span class=\"lineNumber\">6</span>  results.forEach(<span class=\"hljs-function\"><span class=\"hljs-params\">result</span> =></span> {\n<span class=\"lineNumber\">7</span>    <span class=\"hljs-comment\">// balabala ä½ çš„ä»£ç é€»è¾‘</span>\n<span class=\"lineNumber\">8</span>    <span class=\"hljs-comment\">// éƒ½é€šè¿‡äº†</span>\n<span class=\"lineNumber\">9</span>  })\n<span class=\"lineNumber\">10</span>  <span class=\"hljs-comment\">// do more...</span>\n<span class=\"lineNumber\">11</span>}).catch(<span class=\"hljs-function\"><span class=\"hljs-params\">error</span> =></span> {\n<span class=\"lineNumber\">12</span>  <span class=\"hljs-comment\">// å¤±è´¥çš„å€¼, balabala</span>\n<span class=\"lineNumber\">13</span>  <span class=\"hljs-built_in\">console</span>.log(error)\n<span class=\"lineNumber\">14</span>})</code></pre> \n\n<p>å¦‚æœæŸä¸ª<code>testå‡½æ•°</code>è¿”å›çš„<code>promise</code>çŠ¶æ€ä¸º<code>rejected</code>,å¦‚ä¸Šä»£ç ä¹Ÿä¼šå°†é”™è¯¯æ•°æ®ä½œä¸ºå€¼,<code>catch</code>å‡½æ•°ä¹‹åè¿”å›ä¸€ä¸ª<code>fulfilled</code>çŠ¶æ€çš„<code>promise æ–°å®ä¾‹</code>.æœ€ç»ˆ<code>results</code>æ•°ç»„ä¹ŸåŒ…å«äº†å¯èƒ½å‡ºç°çš„é”™è¯¯ä¿¡æ¯,æˆ‘ä»¬å¯ä»¥æ“ä½œåˆå¹¶çš„ç»“æœè¿›è¡Œå¤„ç†.</p>\n<h3>2.2.2 race</h3>\n<p><code>Promise.race(iterable)</code>å¦‚å…¶å,ç±»ä¼¼äº<code>Promise.all()</code>,æ¥æ”¶åŒç±»å‹å‚æ•°,ä¸€æ—¦è¿­ä»£å™¨ä¸­æŸä¸ª<code>promise</code>çŠ¶æ€è½¬åŒ–ä¸º<code>settled</code>,ç«‹å³è¿”å›æ­¤ç»“æœ.</p>\n<blockquote>\n<p>ä¼ å…¥çš„è¿­ä»£ä¸ºç©ºçš„è¯,è¿”å›çš„<code>promise</code>å§‹ç»ˆ<code>pending</code>.</p>\n</blockquote>\n<p><code>Promise.race()</code>éå¸¸é€‚åˆåšå¼‚æ­¥è¯·æ±‚çš„<code>è¶…æ—¶</code>å¤„ç†.æ¥çœ‹ä¸€ä¸ªä¾‹å­:</p>\n<pre><code class=\"hljs language-js\"><span class=\"lineNumber\">1</span><span class=\"hljs-comment\">// asyncApi() è¿”å› promise</span>\n<span class=\"lineNumber\">2</span><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">timeout</span>(<span class=\"hljs-params\">ms</span>) </span>{\n<span class=\"lineNumber\">3</span>  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">resolve, reject</span>) =></span> {\n<span class=\"lineNumber\">4</span>    <span class=\"hljs-built_in\">setTimeout</span>(<span class=\"hljs-function\">() =></span> {\n<span class=\"lineNumber\">5</span>      reject(<span class=\"hljs-string\">`timeout: <span class=\"hljs-subst\">${ms}</span> ms`</span>)\n<span class=\"lineNumber\">6</span>    }, ms)\n<span class=\"lineNumber\">7</span>  })\n<span class=\"lineNumber\">8</span>}\n<span class=\"lineNumber\">9</span> \n<span class=\"lineNumber\">10</span><span class=\"hljs-built_in\">Promise</span>.race([\n<span class=\"lineNumber\">11</span>  asyncApi(<span class=\"hljs-string\">'xx'</span>),\n<span class=\"lineNumber\">12</span>  timeout(<span class=\"hljs-number\">5000</span>)\n<span class=\"lineNumber\">13</span>]).then(<span class=\"hljs-function\"><span class=\"hljs-params\">res</span> =></span> {\n<span class=\"lineNumber\">14</span>  <span class=\"hljs-comment\">// success</span>\n<span class=\"lineNumber\">15</span>}).catch(<span class=\"hljs-function\"><span class=\"hljs-params\">error</span> =></span> {\n<span class=\"lineNumber\">16</span>  <span class=\"hljs-comment\">// timeout or error</span>\n<span class=\"lineNumber\">17</span>})</code></pre> \n\n<h3>2.2.3 any</h3>\n<p><code>Promise.any(iterable)</code>æ˜¯<code>Promise.all()</code>çš„åé¢,å…¶è¯­æ³•æ— å¼‚.</p>\n<p>éœ€è¦æ³¨æ„çš„æ˜¯å¦‚æœä¼ å…¥çš„è¿­ä»£å™¨æ˜¯ç©ºçš„,åˆ™è¿”å›<code>rejected</code>çš„<code>promise </code>å®ä¾‹.åªè¦æœ‰ä¸€ä¸ªæˆåŠŸ,åˆ™è¿”å›æ­¤ç»“æœ.å¦‚æœè¿­ä»£å™¨å†…çš„<code>promise</code>å…¨éƒ¨è¿”å›<code>rejected</code>çŠ¶æ€,åˆ™æœ€ç»ˆè¿”å›<code>rejected</code>çš„<code>promise</code>å®ä¾‹.</p>\n<p>å› æ­¤,æ­¤æ–¹æ³•é€‚ç”¨äºéªŒè¯å¤šä¸ªå¼‚æ­¥ç»“æœä¸­æ˜¯å¦æœ‰<code>fulfilled</code>çš„<code>promise</code>å®ä¾‹.</p>\n<p>å¦‚æœæˆ‘ä»¬éœ€è¦å‘å¤šä¸ªæ•°æ®æºè·å–æŸä¸€ä¸ªæ•°æ®,åˆ™å¯ä»¥ä½¿ç”¨æ­¤æ–¹æ³•æœ€å¿«é€Ÿçš„è·å–åˆ°æ•°æ®,äº¦æˆ–è€…æ‰€æœ‰å¼‚æ­¥è¯·æ±‚éƒ½å¤±è´¥.</p>\n<h3>2.2.4 allSettled</h3>\n<p><code>Promise.allSettled(iterable)</code>æ–¹æ³•è¿”å›ä¸€ä¸ªåœ¨æ‰€æœ‰ç»™å®šçš„<code>promise</code>è½¬ä¸º<code>settled</code>çŠ¶æ€åçš„æ•°ç»„,æ•°ç»„å…ƒç´ æ˜¯æ¯ä¸€ä¸ª<code>promise</code>ç»“æœ.</p>\n<p>å¦‚æœæˆ‘ä»¬æœ‰å¤šä¸ªäº’ä¸ä¾èµ–çš„<code>å¼‚æ­¥ä»»åŠ¡</code>,æˆ–è€…æˆ‘ä»¬æ€»æƒ³çŸ¥é“æ¯ä¸ª<code>promise</code>çš„ç»“æœ,è€Œä¸éœ€è¦å…¶ä¸­çš„<code>rejected</code>çŠ¶æ€<code>promise</code>å»å¼•å‘<code>catch</code>,æ¥çœ‹çœ‹<code>MDN</code>çš„ä¾‹å­:</p>\n<pre><code class=\"hljs language-js\"><span class=\"lineNumber\">1</span><span class=\"hljs-keyword\">const</span> promise1 = <span class=\"hljs-built_in\">Promise</span>.resolve(<span class=\"hljs-number\">3</span>);\n<span class=\"lineNumber\">2</span><span class=\"hljs-keyword\">const</span> promise2 = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">resolve, reject</span>) =></span> <span class=\"hljs-built_in\">setTimeout</span>(reject, <span class=\"hljs-number\">100</span>, <span class=\"hljs-string\">'foo'</span>));\n<span class=\"lineNumber\">3</span><span class=\"hljs-keyword\">const</span> promises = [promise1, promise2];\n<span class=\"lineNumber\">4</span> \n<span class=\"lineNumber\">5</span><span class=\"hljs-built_in\">Promise</span>.allSettled(promises).\n<span class=\"lineNumber\">6</span>  then(<span class=\"hljs-function\">(<span class=\"hljs-params\">results</span>) =></span> results.forEach(<span class=\"hljs-function\">(<span class=\"hljs-params\">result</span>) =></span> <span class=\"hljs-built_in\">console</span>.log(result)));</code></pre> \n\n<p>è¾“å‡ºæ˜¯:</p>\n<pre><code class=\"hljs language-shell\"><span class=\"lineNumber\">1</span><span class=\"hljs-meta\">></span><span class=\"bash\"> Object { status: <span class=\"hljs-string\">\"fulfilled\"</span>, value: 3 }</span>\n<span class=\"lineNumber\">2</span><span class=\"hljs-meta\">></span><span class=\"bash\"> Object { status: <span class=\"hljs-string\">\"rejected\"</span>, reason: <span class=\"hljs-string\">\"foo\"</span> }</span></code></pre> \n\n<p>å¦‚ä¸Šæ‰€ç¤º,çŠ¶æ€ä¸º<code>fulfilled</code>æ—¶,å…·æœ‰<code>value</code>,çŠ¶æ€ä¸º<code>rejected</code>æ—¶,å…·æœ‰<code>reason</code>.</p>\n<p>è¿˜è®°å¾—æˆ‘ä»¬åœ¨<code>Promise.all()</code>ä¸­çš„è¿­ä»£å™¨è¿”å›çš„æ˜¯<code>promise.catch(err => err)</code>å—?å…¶å®,ä½¿ç”¨<code>Promise.allSettled()</code>ç›¸å¯¹æ›´å¥½.</p>\n<h2>2.3 Promise çš„ä¼˜åŠ£</h2>\n<p><code>Promise</code>çš„å‡ºç°ä¿ƒè¿›äº†<code>å¼‚æ­¥</code>ç¼–ç¨‹çš„å‘å±•,æˆ‘ä»¬å¯ä»¥åœ¨æµè§ˆå™¨ç«¯å’Œ<code>node</code>ç«¯çœ‹åˆ°ç»Ÿä¸€çš„<code>Promise</code>ä»£ç .è¿˜è®°å¾—<code>callback</code>å›è°ƒå‡½æ•°çš„å‚æ•°çº¦å®šå—?</p>\n<pre><code class=\"hljs language-js\"><span class=\"lineNumber\">1</span><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">foo</span>(<span class=\"hljs-params\">param, (err, data) => {\n<span class=\"lineNumber\">2</span>  <span class=\"hljs-keyword\">if</span>(err) {\n<span class=\"lineNumber\">3</span>    <span class=\"hljs-regexp\">//</span> balabala\n<span class=\"lineNumber\">4</span>  }\n<span class=\"lineNumber\">5</span>  <span class=\"hljs-regexp\">//</span> balabala\n<span class=\"lineNumber\">6</span>}</span>)</span></code></pre> \n\n<p>è¿™ç§å‚æ•°çº¦å®šæ˜¯è„†å¼±çš„,å¼€å‘è€…å¯ä»¥ä¸æŒ‰æ­¤çº¦å®šç¼–å†™å›è°ƒå‡½æ•°,è¿™ç±»éšè—<code>bug</code>å¯èƒ½å°±æ­¤è€Œç”Ÿ.</p>\n<p><code>Promise</code>çš„å‡ºç°,æˆ‘ä»¬å¿…é¡»ä½¿ç”¨å…¶å®ä¾‹æ–¹æ³•<code>then</code>å’Œ<code>catch</code>å»æŒ‰è§„èŒƒç¼–ç ,å¦åˆ™å°†ä¼šå‡ºé”™,å¼€å‘è€…ä¹Ÿå¯ä»¥çœ‹åˆ°æ˜æ˜¾çš„é”™è¯¯æç¤ºä¿¡æ¯.</p>\n<p>æˆ‘ä»¬å†æ¥çœ‹çœ‹å¦‚ä¸‹ä¸¤ä¸ªä¾‹å­:</p>\n<pre><code class=\"hljs language-js\"><span class=\"lineNumber\">1</span><span class=\"hljs-comment\">// callback</span>\n<span class=\"lineNumber\">2</span>fs.readFile(name, opts?, <span class=\"hljs-function\">(<span class=\"hljs-params\">err, string|Buffer</span>) =></span> <span class=\"hljs-keyword\">void</span>)\n<span class=\"lineNumber\">3</span><span class=\"hljs-comment\">// Promise</span>\n<span class=\"lineNumber\">4</span>readFilePromisified(name, opts?): <span class=\"hljs-built_in\">Promise</span>&#x3C;string | Buffer>         </code></pre> \n\n<p><code>Promise</code>æ–¹æ¡ˆè®©å‡½æ•°å‚æ•°å’Œå›è°ƒè§£è€¦å¼€æ¥,æ‰€æœ‰çš„å‚æ•°éƒ½ç”¨äºæ­¤å‡½æ•°çš„è¾“å…¥.</p>\n<p><code>Promise</code>åœ¨å¤„ç†å•æ¬¡å¼‚æ­¥ä»»åŠ¡çš„æ—¶å€™è¡¨ç°è‰¯å¥½,ä½†æ˜¯å¯¹äºå¤šæ¬¡è§¦å‘çš„ä»»åŠ¡ä¾¿æ˜¾å¾—ä¹åŠ›,ä¹Ÿè®¸æˆ‘ä»¬éœ€è¦å­¦ä¹ ä¸€äº›<code>å“åº”å¼ç¼–ç¨‹</code>æŠ€æœ¯,ä»¥è§£å†³æ­¤ç±»é—®é¢˜.</p>\n<p>å¯¹äº<code>ES6 Promise</code>æ¥è¯´,ç¼ºä¹ä¸¤é¡¹å¾ˆå®ç”¨çš„åŠŸèƒ½:</p>\n<ul>\n<li>å–æ¶ˆä»»åŠ¡(åœ¨ç»„ä»¶è¢«åˆ é™¤åå–æ¶ˆå¼‚æ­¥ä»»åŠ¡ç­‰)</li>\n<li>æŸ¥é˜…è¿›åº¦(æ˜¾ç¤ºè¿›åº¦æ¡ç­‰)</li>\n</ul>\n<p>åŸç”Ÿ<code>Promise</code>æš‚æœªæ”¯æŒä¸Šè¿°ä¸¤é¡¹ç‰¹æ€§,ä¹Ÿè®¸æˆ‘ä»¬å¯ä»¥çœ‹çœ‹ç±»ä¼¼<code>Bluebird</code>è¿™æ ·çš„ç¬¬ä¸‰æ–¹åº“,å®ƒä»¬å®ç°äº†æ›´å¤šåŠŸèƒ½.</p>\n<h1>3. MyPromise</h1>\n<p>å¦‚ä½•å®ç°ä¸€ä¸ªç®€å•çš„<code>Promise</code>?</p>\n<p>éœ€è¦æ˜ç¡®ä¸€ä¸‹å‡ ç‚¹:</p>\n<ul>\n<li>å¯ä»¥ä½¿ç”¨ <code>new</code> åˆ›å»º<code>Promise</code></li>\n<li>å¯ä»¥<code>resolve</code>æˆ–è€…<code>reject</code>,çŠ¶æ€ä¸å¯é€†</li>\n<li>å¯ä»¥é€šè¿‡<code>then</code>æ³¨å†Œå›è°ƒå‡½æ•°,å¯é€‰çš„é“¾å¼è°ƒç”¨æ”¯æŒ,é“¾å¼è°ƒç”¨è¿”å›æ–°çš„<code>Promise</code>.</li>\n</ul>\n<h2>3.1 åˆæ¬¡å°è¯•</h2>\n<pre><code class=\"hljs language-js\"><span class=\"lineNumber\">1</span><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Promise</span> </span>{\n<span class=\"lineNumber\">2</span>  <span class=\"hljs-function\"><span class=\"hljs-title\">constructor</span>(<span class=\"hljs-params\">initFn</span>)</span> {\n<span class=\"lineNumber\">3</span>    <span class=\"hljs-built_in\">this</span>.status = <span class=\"hljs-string\">'pending'</span>\n<span class=\"lineNumber\">4</span>    initFn()\n<span class=\"lineNumber\">5</span>  }\n<span class=\"lineNumber\">6</span>  \n<span class=\"lineNumber\">7</span>  <span class=\"hljs-function\"><span class=\"hljs-title\">then</span>(<span class=\"hljs-params\">fn</span>)</span> {\n<span class=\"lineNumber\">8</span>    \n<span class=\"lineNumber\">9</span>  }\n<span class=\"lineNumber\">10</span>}</code></pre> \n\n<h1>å‚è€ƒ</h1>\n<ul>\n<li><a href=\"https://www.ruanyifeng.com/blog/2014/10/event-loop.html\">JavaScript è¿è¡Œæœºåˆ¶è¯¦è§£ï¼šå†è°ˆEvent Loop - é˜®ä¸€å³°çš„ç½‘ç»œæ—¥å¿—</a></li>\n<li><a href=\"https://notes.forkai.com/2017/11/06/javascript%E8%BF%9B%E9%98%B601%EF%BC%9A%E5%BC%82%E6%AD%A51-%E4%BA%8B%E4%BB%B6%E7%9B%91%E5%90%AC%E5%92%8C%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0/\">JavaScriptè¿›é˜¶01ï¼šå¼‚æ­¥1-äº‹ä»¶ç›‘å¬å’Œå›è°ƒå‡½æ•° | forkai's Notes</a></li>\n<li><a href=\"https://stackoverflow.com/questions/2069763/difference-between-event-handlers-and-callbacks\">architecture - Difference between event handlers and callbacks - Stack Overflow</a></li>\n<li><a href=\"https://stackoverflow.com/questions/6348494/addeventlistener-vs-onclick\">javascript - addEventListener vs onclick - Stack Overflow</a></li>\n<li><a href=\"http://bluebirdjs.com/docs/getting-started.html\">Getting Started | bluebird</a></li>\n</ul>\n","title":"Javascript,I promise - å¼‚æ­¥ç¼–ç¨‹","date":"2021/4/9","tags":["JavaScript"],"mainImg":"https://images.unsplash.com/photo-1611923973164-e0e5f7f69872?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=MnwxNjUyNjZ8MHwxfHJhbmRvbXx8fHx8fHx8fDE2MTc5NzU1MTI&ixlib=rb-1.2.1&q=80&w=1080","coverImg":"https://images.unsplash.com/photo-1611923973164-e0e5f7f69872?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=MnwxNjUyNjZ8MHwxfHJhbmRvbXx8fHx8fHx8fDE2MTc5NzU1MTI&ixlib=rb-1.2.1&q=80&w=400","intro":"Promise, JavaScript ä¸–ç•Œä¸­çš„å¼‚æ­¥å¤„ç†å¯¹è±¡.æˆ‘é˜…è¯»äº† Dr.Axel å‰è¾ˆçš„ç”µå­ä¹¦,å……æ»¡æ„Ÿæ¿€."}},"__N_SSG":true}