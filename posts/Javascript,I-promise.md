---
title: 'Javascript,I promise - å¼‚æ­¥ç¼–ç¨‹'
date: '2021/4/9'
tags:
- JavaScript
mainImg: 'https://images.unsplash.com/photo-1611923973164-e0e5f7f69872?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=MnwxNjUyNjZ8MHwxfHJhbmRvbXx8fHx8fHx8fDE2MTc5NzU1MTI&ixlib=rb-1.2.1&q=80&w=1080'
coverImg: 'https://images.unsplash.com/photo-1611923973164-e0e5f7f69872?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=MnwxNjUyNjZ8MHwxfHJhbmRvbXx8fHx8fHx8fDE2MTc5NzU1MTI&ixlib=rb-1.2.1&q=80&w=400'
intro: 'Promise, JavaScript ä¸–ç•Œä¸­çš„å¼‚æ­¥å¤„ç†å¯¹è±¡.æˆ‘é˜…è¯»äº† Dr.Axel å‰è¾ˆçš„ç”µå­ä¹¦,å……æ»¡æ„Ÿæ¿€.'
---

è™½ç„¶æ­¤å‰æˆ‘å·²ç»æ¥è§¦è¿‡ä¸€äº›å¼‚æ­¥ç¼–ç¨‹çš„æ¦‚å¿µ,å¹¶ä¸”æœ‰è¿‡ä¸€å®šçš„å®é™…è¿ç”¨.ä½†æ˜¯è‡ªæˆ‘æ„Ÿè§‰,æˆ‘å¯¹`JavaScript`å¼‚æ­¥ç¼–ç¨‹çš„äº†è§£ä¾ç„¶ååˆ†æµ…æ˜¾,å› æ­¤æˆ‘æ‰“ç®—å†æ¬¡å¯¹`JavaScript`ä¸­çš„å¼‚æ­¥ç¼–ç¨‹è¿›è¡Œå­¦ä¹ å’Œæ€»ç»“,ç„¶ååˆ†äº«å‡ºæ¥.

# 1. å‰æ–‡

åœ¨å¯¹`Promise`çŸ¥è¯†è¿›è¡Œæ€»ç»“ä¹‹å‰,æˆ‘å°†å›é¡¾ä¸€éƒ¨åˆ†`JavaScript`ä¸å¼‚æ­¥ç¼–ç¨‹ç›¸å…³çš„çŸ¥è¯†.

## 1.1 æµ…è¿° JavaScript è°ƒç”¨æ ˆ

å½“å‡½æ•°ä¹‹é—´å‘ç”Ÿå†…åµŒè°ƒç”¨,å°†äº§ç”Ÿ`å‡½æ•°è°ƒç”¨æ ˆ`.

> `å‡½æ•°è°ƒç”¨æ ˆ`æ˜¯è§£é‡Šå™¨è¿½è¸ªå‡½æ•°æ‰§è¡Œæµçš„ä¸€ç§æœºåˆ¶,å‡½æ•°å…¥æ ˆçš„åŒäº‹ä¹Ÿä¿å­˜äº†å…¶ä¸Šä¸‹æ–‡ç¯å¢ƒ.

```js
function h(z) {
  console.log(new Error().stack)
}
function g(y) {
  h(y + 1)
}
function f(x) {
  g(x + 1)
}
f(1)
```

å¦‚ä¸Šè¿°,éšç€è°ƒç”¨å‡½æ•°`f(1)`,è°ƒç”¨æ ˆå†…å¼€å§‹å­˜å‚¨å‡½æ•°`f(1)`,å†…éƒ¨è°ƒç”¨äº†`g(2)`ä¹Ÿè¢«å­˜å…¥è°ƒç”¨æ ˆ,æœ€åå°†`h(3)`å­˜å…¥è°ƒç”¨æ ˆ,å½“å‰å‡½æ•°æ‰§è¡Œç»“æŸå³å°†ä¹‹ä»è°ƒç”¨æ ˆå®šç§»é™¤,æ¥ç€æ‰§è¡Œå¯èƒ½å­˜åœ¨çš„å‰©ä½™ä»£ç ,æœ€ç»ˆè°ƒç”¨æ ˆè¢«æ¸…ç©º,æ‰§è¡Œæµç¨‹å›åˆ°å…¨å±€ä½œç”¨åŸŸ,æœ€ç»ˆæ‰“å°å¦‚ä¸‹:

```js
Error
    at h (REPL3:2:15)
    at g (REPL6:2:3)
    at f (REPL9:2:3)
    at REPL10:1:1
    at Script.runInThisContext (node:vm:133:18)
    at REPLServer.defaultEval (node:repl:474:29)
    at bound (node:domain:416:15)
    at REPLServer.runBound [as eval] (node:domain:427:12)
    at REPLServer.onLine (node:repl:793:10)
    at REPLServer.emit (node:events:388:22)
```

æ ˆæ˜¯æœ‰é™åº¦çš„,ä¸åŒç¯å¢ƒçš„æ ˆç©ºé—´å¤§å°ä¸ç­‰,åˆ†é…çš„æ ˆç©ºé—´è¢«å æ»¡ä¹‹å,å°†ä¼šå¼•å‘æ ˆæº¢å‡ºé”™è¯¯.



## 1.2 æµ…è¿°æµè§ˆå™¨äº‹ä»¶å¾ªç¯

æˆ‘ä»¬å¯ä»¥ç®€å•çš„è®¤ä¸ºæ¯ä¸ªæµè§ˆå™¨`tab`è¿è¡Œäºä¸€ä¸ªç®€å•çš„`äº‹ä»¶å¾ªç¯`è¿›ç¨‹æ¥å®ç°`éé˜»å¡`,æµè§ˆå™¨ä¸­çš„è¯¸å¤šå•ä¸€ä»»åŠ¡,ä¾‹å¦‚:

- è§£æ HTML
- æ‰§è¡Œè„šæœ¬ä¸­çš„ JavaScript ä»£ç 
- å“åº”ç”¨æˆ·äº¤äº’
- å¼‚æ­¥ç½‘ç»œè¯·æ±‚
- ç­‰ç­‰

è¿™äº›ä»»åŠ¡å½¢æˆäº†ç‹¬ç«‹äºä¸»çº¿ç¨‹çš„`ä»»åŠ¡é˜Ÿåˆ—(task queue)`,æ‰€æœ‰ä»»åŠ¡åªèƒ½é€ä¸€é€šçŸ¥ä¸»çº¿ç¨‹è¿›è¡Œå¤„ç†.ç”±äº`JavaScript`çš„å•çº¿ç¨‹é™åˆ¶,å³ä½¿`Web Workeræ ‡å‡†`å…è®¸`JavaScript`è„šæœ¬åˆ›å»ºå¤šä¸ªçº¿ç¨‹,ä½†æ˜¯å­çº¿ç¨‹ç”±ä¸»çº¿ç¨‹æ§åˆ¶,ä¸”ä¸å¯æ“ä½œ`DOM`,å¯ä»¥è¯´`JavaScript`çš„æœ¬è´¨ä¾ç„¶æ˜¯`å•çº¿ç¨‹`.

å¦‚ä¸‹æ˜¯`Philip Roberts`æ¼”è®²çš„æ—¶å€™ä½¿ç”¨çš„ç¤ºæ„å›¾:

![](https://www.ruanyifeng.com/blogimg/asset/2014/bg2014100802.png)

å½“ä¸»çº¿ç¨‹æ‰§è¡Œæ ˆä¸Šçš„åŒæ­¥ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ä¹‹å,å°±å»è¯»å–`task queue`,æŒ‰é˜Ÿåˆ—å…ˆè¿›å…ˆå‡ºçš„å±æ€§,ä¾æ¬¡è·å–ä»»åŠ¡è¿›è¡Œå¤„ç†,ç„¶åé‡å¤æ£€æŸ¥ä¸»çº¿ç¨‹æ‰§è¡Œæ ˆ,é€šå¸¸æˆ‘ä»¬ä¸ºå¼‚æ­¥äº‹ä»¶ç¼–å†™çš„`å›è°ƒå‡½æ•°`,å°±è¿›å…¥äº†ä»»åŠ¡é˜Ÿåˆ—.

å¦‚æœå†ç»†åˆ†ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡,ä¾ç„¶å¯ä»¥åˆ†ä¸º:

- å¾®ä»»åŠ¡(micro task)
- å®ä»»åŠ¡(macro task)

åƒ`setTimeout`å’Œ`setInterval`åˆ™æ˜¯å®ä»»åŠ¡.

> **å½“å‰æ‰§è¡Œæ ˆæ‰§è¡Œå®Œæ¯•æ—¶ä¼šç«‹åˆ»å…ˆå¤„ç†æ‰€æœ‰å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„äº‹ä»¶ï¼Œç„¶åå†å»å®ä»»åŠ¡é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªäº‹ä»¶ã€‚åŒä¸€æ¬¡äº‹ä»¶å¾ªç¯ä¸­ï¼Œå¾®ä»»åŠ¡æ°¸è¿œåœ¨å®ä»»åŠ¡ä¹‹å‰æ‰§è¡Œ**ã€‚

## 1.3 å®šæ—¶å™¨ç®€æ

`setTimeout(callback, ms)`å‡½æ•°åˆ›å»ºäº†ä¸€ä¸ªå®šæ—¶å™¨ç­‰å¾…è‹¥å¹²æ¯«ç§’, ç„¶åå°†`callback`æ”¾å…¥`task queue`,å¹¶ä¸”åœ¨ç­‰å¾…è®¡æ—¶å™¨çš„å…¶é—´è„±ç¦»äº†ä¸»çº¿ç¨‹,è¿™ä¹Ÿå°±æ„å‘³ç€å¦‚æœä¸»çº¿ç¨‹æ‰§è¡Œäº†è€—æ—¶çš„åŒæ­¥ä»»åŠ¡,åˆ™ä»»åŠ¡é˜Ÿåˆ—è¢«è¯»å–çš„æ—¶é—´å°±å°†è¢«å»¶è¿Ÿäº†,å› æ­¤å¯èƒ½ä¸ä¼šåœ¨`ms`æ¯«ç§’åæ‰§è¡Œ`callback`å›è°ƒå‡½æ•°.

å®é™…å»¶æ—¶è¿˜æœ‰å…¶ä»–çš„å½±å“å› ç´ .

- ä¸åŒæµè§ˆå™¨å…·æœ‰è‡ªå·±çš„`DOM_MIN_TIMEOUT_VALUE`,æœ€å°å»¶æ—¶å€¼.
- ä¸ºäº†ä¼˜åŒ–åå° tab çš„åŠ è½½æŸè€—(ä»¥åŠé™ä½è€—ç”µé‡),åœ¨æœªè¢«æ¿€æ´»çš„ tab ä¸­å®šæ—¶å™¨çš„æœ€å°å»¶æ—¶é™åˆ¶ä¸º`1S`.
- è¿½è¸ªå‹è„šæœ¬å»¶æ—¶åœ¨åå° tabs ä¸­,è¿™ä¸ªæœ€å°å»¶æ—¶é™åˆ¶æ˜¯ `10S`,è¿™ä¸ªé™åˆ¶ä¼šåœ¨æ–‡æ¡£ç¬¬ä¸€æ¬¡åŠ è½½åçš„`30s`åç”Ÿæ•ˆ.



## 1.4 æ˜¾ç¤º DOM å˜åŒ–

å¯¹äºå¤§å¤šæ•°`DOM`å…ƒç´ çš„å˜åŒ–æ¥è¯´,å®ƒä»¬çš„æ”¹åŠ¨æ•°æ®å¹¶ä¸æ˜¯å®æ—¶æ›´æ–°çš„,`DOM`å’Œ`å¸ƒå±€`çš„æ”¹åŠ¨ä¹Ÿä¸`äº‹ä»¶å¾ªç¯`æœºåˆ¶æœ‰å…³.å¦‚æœéœ€è¦é¢‘ç¹æ›´æ–°`DOM`,å¯ä»¥è€ƒè™‘`requestAnimationFrame()`å‡½æ•°.

> **`window.requestAnimationFrame()`** å‘Šè¯‰æµè§ˆå™¨â€”â€”ä½ å¸Œæœ›æ‰§è¡Œä¸€ä¸ªåŠ¨ç”»ï¼Œå¹¶ä¸”è¦æ±‚æµè§ˆå™¨åœ¨ä¸‹æ¬¡é‡ç»˜ä¹‹å‰è°ƒç”¨æŒ‡å®šçš„å›è°ƒå‡½æ•°æ›´æ–°åŠ¨ç”»ã€‚è¯¥æ–¹æ³•éœ€è¦ä¼ å…¥ä¸€ä¸ªå›è°ƒå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œè¯¥å›è°ƒå‡½æ•°ä¼šåœ¨æµè§ˆå™¨ä¸‹ä¸€æ¬¡é‡ç»˜ä¹‹å‰æ‰§è¡Œ

## 1.5 event loop é˜»å¡å’Œæ¶ˆé™¤

æ¥çœ‹çœ‹ä¸€ä¸ªé˜»å¡äº‹ä»¶å¾ªç¯çš„ä¾‹å­ğŸŒ° From `Dr. Axel Rauschmayer`:

```js
<p>
  <a id="block" href="">Block for 5 seconds</a>
<p>
    <button id="btn">This is a button</button>
<div id="statusMessage"></div>
<script>
document.getElementById('block').addEventListener('click', onClick);
document.getElementById('btn').addEventListener('click', onClickBtn);

function onClickBtn() {
  console.log("click the btn")
}

function onClick(event) {
  event.preventDefault();

  setStatusMessage('Blocking...');

  // Call setTimeout(), so that browser has time to display
  // status message
  setTimeout(function () {
    sleep(5000);
    setStatusMessage('Done');
  }, 0);
}
function setStatusMessage(msg) {
  document.getElementById('statusMessage').textContent = msg;
}
function sleep(milliseconds) {
  var start = Date.now();
  while ((Date.now() - start) < milliseconds);
}
</script>
```

æˆ‘ç»™`button`åŠ äº†ç‚¹å‡»ç›‘å¬,å¦‚ä¸Šæ‰€ç¤º,å½“ä½ ç‚¹å‡»é“¾æ¥è§¦å‘ç›‘å¬å‡½æ•°çš„æ—¶å€™å†ç‚¹å‡»`button`,äº‹ä»¶å¾ªç¯è¢«é˜»å¡5ç§’.è¿™ä¸ªæœŸé—´ç‚¹å‡»`button`çš„ç›‘å¬å‡½æ•°æ— æ³•å¦‚`"é¢„æœŸ"`é©¬ä¸Šæ‰§è¡Œå…¶é€»è¾‘,é˜»å¡çŠ¶æ€ç»“æŸä¹‹å,ç‚¹å‡»å‡½æ•°çš„ç›‘å¬æ•ˆæœæ‰ä¼šå‡ºç°.

æˆ‘ä»¬æœ‰ä¸¤ç§æ–¹æ³•æ¶ˆé™¤äº‹ä»¶å¾ªç¯çš„é˜»å¡,å…¶ä¸€ä¾¿æ˜¯å°†è€—æ—¶çš„ä»»åŠ¡è½¬ç§»åˆ°`Worker API`ä¸­å»,è®©å¦ä¸€ä¸ªçº¿ç¨‹å»å¤„ç†.å…¶äºŒä¾¿æ˜¯ä¸ä½¿ç”¨åŒæ­¥çš„é•¿æ—¶é—´ç­‰å¾…é€»è¾‘,è€Œæ˜¯é€‰æ‹©ä½¿ç”¨å¼‚æ­¥çš„æ–¹å¼å»æ”¹å†™è€—æ—¶çš„åŒæ­¥ä»£ç .ä¾‹å¦‚ä¸Šè¿°çš„`sleep`å‡½æ•°ä¾¿å¯ä»¥ä½¿ç”¨`setTimeout`æ¥è®©æˆ‘ä»¬è¾¾åˆ°å¼‚æ­¥çš„æ•ˆæœ.

## 1.6 å¼‚æ­¥æ¥æ”¶ç»“æœ



# å‚è€ƒ

- [JavaScript è¿è¡Œæœºåˆ¶è¯¦è§£ï¼šå†è°ˆEvent Loop - é˜®ä¸€å³°çš„ç½‘ç»œæ—¥å¿—](https://www.ruanyifeng.com/blog/2014/10/event-loop.html)